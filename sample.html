<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>Designer Sample Creation Form</title>
<link rel="icon" href="data:,">
<style>
body {font-family: Arial, sans-serif;background:#f8f9fa;margin:0;padding:0;}
.container {width:90%;max-width:1100px;margin:40px auto;background:#fff;padding:30px;border-radius:12px;
  box-shadow:0 0 10px rgba(0,0,0,0.1);}
h1{text-align:center;color:#007bff;margin-bottom:25px;}
label{display:block;margin-top:10px;font-weight:bold;}
input,select,textarea{width:100%;padding:8px;margin-top:4px;border:1px solid #ccc;border-radius:6px;font-size:14px;}
textarea{resize:vertical;}
.row{display:flex;gap:10px;margin-bottom:8px;}
button{background:#007bff;color:#fff;border:none;padding:10px 18px;border-radius:6px;cursor:pointer;font-size:16px;margin-top:15px;}
button:disabled{background:#ccc;cursor:not-allowed;}
#msg{margin-top:15px;font-weight:bold;text-align:center;}
h3{background:#007bff;color:#fff;padding:6px 10px;border-radius:4px;margin-top:20px;font-size:16px;}
</style>
</head>
<body>
<div class="container">
<h1>Designer Sample Creation Form</h1>

<form id="entryForm"
      action="https://script.google.com/macros/s/AKfycbwpbCvnRpjaMIQi-SCWMNcIMgJXDqrCr3Y5K4uZ-OZpQ35GuBmoejLeC1MY5TvR0rMK/exec"
      method="POST"
      enctype="multipart/form-data"
      target="uploadFrame"
      novalidate>

<div class="row">
  <div style="flex:1">
    <label>Designer Name*</label>
    <select id="designerName" name="designerName" required></select>
  </div>
  <div style="flex:1">
    <label>Unit*</label>
    <select id="unit" name="unit" required></select>
  </div>
</div>

<div class="row">
  <div style="flex:1">
    <label>Product Name*</label>
    <select id="productName" name="productName" required></select>
  </div>
  <div style="flex:1">
    <label>Print Style ID*</label>
    <select id="printStyleId" name="printStyleId" required></select>
  </div>
</div>

<div class="row">
  <div style="flex:1">
    <label>Print Style No*</label>
    <select id="printStyleNo" name="printStyleNo" required></select>
  </div>
  <div style="flex:1">
    <label>Design No*</label>
    <input type="text" id="designNo" name="designNo" required>
  </div>
</div>

<div class="row">
  <div style="flex:1">
    <label>Color*</label>
    <input type="text" id="color" name="color" required>
  </div>
  <div style="flex:1">
    <label>Top Length*</label>
    <input type="text" id="topLength" name="topLength">
  </div>
</div>

<div class="row">
  <div style="flex:1">
    <label>Bottom Length*</label>
    <input type="text" id="bottomLength" name="bottomLength">
  </div>
  <div style="flex:1">
    <label>Details</label>
    <textarea id="details" name="details"></textarea>
  </div>
</div>

<div class="row">
  <div style="flex:1">
    <label>Product Image (Front)*</label>
    <input type="file" id="productImage" name="productImage" accept="image/*">
  </div>
  <div style="flex:1">
    <label>Product Image (Back)</label>
    <input type="file" id="productImageBack" name="productImageBack" accept="image/*">
  </div>
</div>

<h3>Materials</h3>
<div id="materials"></div>

<h3>Attachments</h3>
<div id="attachments"></div>

<p id="msg"></p>
<button id="submitBtn" type="submit">Save</button>
</form>
</div>

<iframe name="uploadFrame" style="display:none"></iframe>

<script>
const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwpbCvnRpjaMIQi-SCWMNcIMgJXDqrCr3Y5K4uZ-OZpQ35GuBmoejLeC1MY5TvR0rMK/exec"; // same as form action

// ---------- JSONP dropdown loader ----------
<script>
// Replace both functions with these:

function populateDropdowns(data){
  const map = {
    designerName : data?.designers || [],
    unit         : data?.units || [],
    productName  : data?.products || [],
    printStyleId : data?.printStyleIDs || [],
    printStyleNo : data?.printStyleNos || []
  };
  for (const [id, arr] of Object.entries(map)) {
    const el = document.getElementById(id);
    if (!el) { console.warn("Missing select id:", id); continue; }
    el.innerHTML = "<option value=''>Select</option>" +
      arr.map(v => `<option>${String(v)}</option>`).join("");
  }
}

function loadDropdownsJSONP(){
  const msg = document.getElementById("msg");
  if (msg) msg.textContent = "Loading dropdowns...";

  // 1) Build a unique callback
  const cb = "cbDropdown_" + Date.now();
  let gotCallback = false;

  // 2) Define the callback *before* loading the script
  window[cb] = function(data){
    try {
      gotCallback = true;
      console.log("[JSONP] callback hit:", cb, data);
      populateDropdowns(data);
      if (msg) msg.textContent = ""; // clear loading text only on success
    } catch (err) {
      console.error("Dropdown populate error:", err);
      if (msg) msg.textContent = "❌ Dropdown populate failed";
    } finally {
      // cleanup
      const scr = document.getElementById(cb);
      if (scr) scr.remove();
      delete window[cb];
    }
  };

  // 3) Inject the script tag
  const s = document.createElement("script");
  s.id = cb;
  s.src = `${SCRIPT_URL}?action=getDropdownValues&callback=${cb}`;
  s.async = true;

  // Diagnostics
  s.onload = () => console.log("[JSONP] script loaded:", s.src);
  s.onerror = () => {
    console.error("[JSONP] network error loading:", s.src);
    if (msg) msg.textContent = "❌ Failed to load dropdowns (network)";
    delete window[cb];
    s.remove();
  };

  // 4) Timeout guard (5s) if callback never fires
  setTimeout(() => {
    if (!gotCallback) {
      console.error("[JSONP] callback not invoked within 5s:", cb);
      if (msg) msg.textContent = "❌ Failed to load dropdowns";
      const scr = document.getElementById(cb);
      if (scr) scr.remove();
      delete window[cb];
    }
  }, 5000);

  document.body.appendChild(s);
}

// ---------- dynamic rows ----------
function buildDynamicRows(){
  const matDiv=document.getElementById("materials");
  matDiv.innerHTML="";
  for(let i=1;i<=5;i++){
    const row=document.createElement("div");
    row.className="row";
    row.innerHTML=`
      <input type="text" id="matName${i}" name="matName${i}" placeholder="Material ${i} Name">
      <input type="text" id="matQty${i}" name="matQty${i}" placeholder="Qty">`;
    matDiv.appendChild(row);
  }
  const attDiv=document.getElementById("attachments");
  attDiv.innerHTML="";
  for(let i=1;i<=5;i++){
    const row=document.createElement("div");
    row.className="row";
    row.innerHTML=`
      <input type="text" id="attName${i}" name="attName${i}" placeholder="Attachment ${i} Name">
      <input type="file" id="attPhoto${i}" name="attPhoto${i}" accept="image/*" class="file-input">`;
    attDiv.appendChild(row);
  }
}

// ---------- initialize ----------
document.addEventListener("DOMContentLoaded",()=>{
  document.getElementById("msg").textContent="Loading dropdowns...";
  buildDynamicRows();
  loadDropdownsJSONP();

  const form=document.getElementById("entryForm");
  const btn=document.getElementById("submitBtn");
  const msg=document.getElementById("msg");

  // no preventDefault()
  form.addEventListener("submit",()=>{
    btn.disabled=true;
    msg.textContent="Saving...";
    console.log("SCRIPT_URL =", SCRIPT_URL);

  });

  // receive iframe response
  window.addEventListener("message",(ev)=>{
    try{
      const res=JSON.parse(ev.data||"{}");
      if(res.success){
        msg.textContent="✅ Saved successfully!";
        form.reset();
        buildDynamicRows();
      }else{
        msg.textContent="❌ "+(res.error||"Failed to save");
      }
    }catch(_){}
    btn.disabled=false;
  });
});
</script>
</body>
</html>
      
