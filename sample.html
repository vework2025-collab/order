<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Designer Sample Creation Form — FIX</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link rel="icon" href="data:,">
<style>
  body{font-family:Arial, sans-serif;background:#f8f9fa;margin:0}
  .container{width:90%;max-width:1100px;margin:32px auto;background:#fff;padding:24px;border-radius:12px;box-shadow:0 2px 12px rgba(0,0,0,.06)}
  h1{margin:0 0 16px;color:#0b6dff}
  label{display:block;font-weight:600;margin-top:8px}
  input,select,textarea{width:100%;padding:8px;margin-top:4px;border:1px solid #d0d5dd;border-radius:8px}
  .row{display:flex;gap:12px;margin:10px 0}
  .row > *{flex:1}
  h3{margin-top:18px;background:#0b6dff;color:#fff;padding:6px 10px;border-radius:6px;font-size:15px}
  #msg{margin-top:10px;font-weight:700;text-align:center}
  button{margin-top:12px;background:#0b6dff;color:#fff;border:0;border-radius:8px;padding:10px 16px;font-weight:700;cursor:pointer}
  .muted{color:#667085;font-size:13px;margin:6px 0 0}
  .error{color:#b42318}
  .ok{color:#05603a}
  pre.debug{background:#0b1220;color:#e5e7eb;padding:10px;border-radius:8px;overflow:auto;font-size:12px}
</style>
</head>
<body>
<div class="container">
  <h1>Designer Sample Creation Form</h1>

  <div id="msg" class="muted">Loading dropdowns…</div>
  <pre id="debug" class="debug" style="display:none"></pre>

  <form id="entryForm"
        action="https://script.google.com/macros/s/AKfycbyA-E2zce-N2l2Y3x3WtxXrwZ7W3u447Wwd7Y2E3TeEIPNAL4dej0Vcnk9R1eQ3xnw1/exec"
        method="POST"
        enctype="multipart/form-data"
        target="uploadFrame"
        novalidate>

    <div class="row">
      <div>
        <label>Designer Name*</label>
        <select id="designerName" name="designerName" required></select>
      </div>
      <div>
        <label>Unit*</label>
        <select id="unit" name="unit" required></select>
      </div>
    </div>

    <div class="row">
      <div>
        <label>Product Name*</label>
        <select id="productName" name="productName" required></select>
      </div>
      <div>
        <label>Print Style ID*</label>
        <select id="printStyleId" name="printStyleId" required></select>
      </div>
    </div>

    <div class="row">
      <div>
        <label>Print Style No*</label>
        <select id="printStyleNo" name="printStyleNo" required></select>
      </div>
      <div>
        <label>Design No*</label>
        <input id="designNo" name="designNo" required />
      </div>
    </div>

    <div class="row">
      <div>
        <label>Color*</label>
        <input id="color" name="color" required />
      </div>
      <div>
        <label>Top Length*</label>
        <input id="topLength" name="topLength" />
      </div>
    </div>

    <div class="row">
      <div>
        <label>Bottom Length*</label>
        <input id="bottomLength" name="bottomLength" />
      </div>
      <div>
        <label>Details</label>
        <textarea id="details" name="details"></textarea>
      </div>
    </div>

    <div class="row">
      <div>
        <label>Product Image (Front)*</label>
        <input type="file" id="productImage" name="productImage" accept="image/*" />
      </div>
      <div>
        <label>Product Image (Back)</label>
        <input type="file" id="productImageBack" name="productImageBack" accept="image/*" />
      </div>
    </div>

    <h3>Materials</h3>
    <div id="materials"></div>

    <h3>Attachments</h3>
    <div id="attachments"></div>

    <button id="submitBtn" type="submit">Save</button>
  </form>
</div>

<iframe name="uploadFrame" style="display:none"></iframe>

<script>
/* ====== CONFIG ====== */
const SCRIPT_URL = document.getElementById('entryForm').getAttribute('action');

/* ====== UI ALWAYS BUILDS ====== */
function buildDynamicRows(){
  const mat = document.getElementById("materials");
  const att = document.getElementById("attachments");
  // materials
  mat.innerHTML = "";
  for (let i=1;i<=5;i++){
    const row = document.createElement("div");
    row.className = "row";
    row.innerHTML = `
      <input type="text" id="matName${i}" name="matName${i}" placeholder="Material ${i} Name" />
      <input type="text" id="matQty${i}" name="matQty${i}" placeholder="Qty" />`;
    mat.appendChild(row);
  }
  // attachments
  att.innerHTML = "";
  for (let i=1;i<=5;i++){
    const row = document.createElement("div");
    row.className = "row";
    row.innerHTML = `
      <input type="text" id="attName${i}" name="attName${i}" placeholder="Attachment ${i} Name" />
      <input type="file" id="attPhoto${i}" name="attPhoto${i}" accept="image/*" />`;
    att.appendChild(row);
  }
}

/* ====== DROPDOWN LOADER (CORS POST) ====== */
async function loadDropdowns(){
  const msg = document.getElementById("msg");
  const dbg = document.getElementById("debug");
  dbg.style.display = "block";
  dbg.textContent = "SCRIPT_URL = " + SCRIPT_URL + "\nStarting fetch…";

  try {
    const res = await fetch(SCRIPT_URL, {
      method: "POST",
      mode: "cors",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ action: "getDropdownValues" })
    });
    dbg.textContent += "\nStatus: " + res.status + " " + res.statusText;
    const data = await res.json();
    dbg.textContent += "\nData: " + JSON.stringify(data).slice(0,400) + (JSON.stringify(data).length>400?"…":"");

    const map = {
      designerName : data.designers || [],
      unit         : data.units || [],
      productName  : data.products || [],
      printStyleId : data.printStyleIDs || [],
      printStyleNo : data.printStyleNos || []
    };
    for (const [id, arr] of Object.entries(map)){
      const el = document.getElementById(id);
      if (!el) continue;
      el.innerHTML = "<option value=''>Select</option>" + arr.map(v=>`<option>${String(v)}</option>`).join("");
    }
    msg.textContent = "Dropdowns loaded";
    msg.className = "ok";
  } catch (err) {
    console.error(err);
    document.getElementById("msg").textContent = "❌ Failed to load dropdowns";
    document.getElementById("msg").className = "error";
    dbg.textContent += "\nERROR: " + (err && err.message ? err.message : String(err));
  }
}

/* ====== INIT ====== */
window.addEventListener("error", (e)=>{
  const dbg = document.getElementById("debug");
  dbg.style.display = "block";
  dbg.textContent += "\nJS ERROR: " + e.message + " @ " + e.filename + ":" + e.lineno;
});
document.addEventListener("DOMContentLoaded", ()=>{
  buildDynamicRows();       // ← fields ALWAYS render now
  loadDropdowns();          // ← populate dropdowns (POST+CORS)
  const form = document.getElementById("entryForm");
  const btn  = document.getElementById("submitBtn");
  const msg  = document.getElementById("msg");
  form.addEventListener("submit", ()=>{
    btn.disabled = true;
    msg.textContent = "Saving…";
  });
  window.addEventListener("message",(ev)=>{
    try{
      const res = JSON.parse(ev.data||"{}");
      if (res.success){
        msg.textContent = "✅ Saved";
        msg.className = "ok";
        form.reset();
        buildDynamicRows();
      } else {
        msg.textContent = "❌ " + (res.error || "Failed to save");
        msg.className = "error";
      }
    }catch(_){}
    btn.disabled = false;
  });
});
</script>
</body>
</html>
