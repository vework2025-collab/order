<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Designer Sample Creation Form</title>
  <link rel="icon" href="data:,">
  <style>
    body {
      font-family: Arial, sans-serif;
      background-color: #f8f9fa;
      margin: 0;
      padding: 0;
    }
    .container {
      width: 90%;
      max-width: 1000px;
      margin: 40px auto;
      background: #fff;
      padding: 30px;
      border-radius: 12px;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
    }
    h1 {
      text-align: center;
      color: #007bff;
      margin-bottom: 25px;
    }
    label {
      display: block;
      margin-top: 10px;
      font-weight: bold;
    }
    input, select, textarea {
      width: 100%;
      padding: 8px;
      margin-top: 4px;
      border: 1px solid #ccc;
      border-radius: 6px;
      font-size: 14px;
    }
    textarea { resize: vertical; }
    .row {
      display: flex;
      gap: 10px;
      margin-bottom: 8px;
    }
    .file-input {
      width: 100%;
    }
    button {
      background: #007bff;
      color: #fff;
      border: none;
      padding: 10px 18px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 16px;
      margin-top: 15px;
    }
    button:disabled {
      background: #ccc;
      cursor: not-allowed;
    }
    #msg {
      margin-top: 15px;
      font-weight: bold;
      text-align: center;
    }
    h3 {
      background: #007bff;
      color: white;
      padding: 6px 10px;
      border-radius: 4px;
      margin-top: 20px;
      font-size: 16px;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Designer Sample Creation Form</h1>

    <form id="entryForm">
      <div class="row">
        <div style="flex:1">
          <label for="designerName">Designer Name*</label>
          <select id="designerName" required></select>
        </div>
        <div style="flex:1">
          <label for="unit">Unit*</label>
          <select id="unit" required></select>
        </div>
      </div>

      <div class="row">
        <div style="flex:1">
          <label for="productName">Product Name*</label>
          <select id="productName" required></select>
        </div>
        <div style="flex:1">
          <label for="printStyleId">Print Style ID*</label>
          <select id="printStyleId" required></select>
        </div>
      </div>

      <div class="row">
        <div style="flex:1">
          <label for="printStyleNo">Print Style No*</label>
          <select id="printStyleNo" required></select>
        </div>
        <div style="flex:1">
          <label for="designNo">Design No*</label>
          <input type="text" id="designNo" required>
        </div>
      </div>

      <div class="row">
        <div style="flex:1">
          <label for="color">Color*</label>
          <input type="text" id="color" required>
        </div>
        <div style="flex:1">
          <label for="topLength">Top Length*</label>
          <input type="text" id="topLength" placeholder="In CM">
        </div>
      </div>

      <div class="row">
        <div style="flex:1">
          <label for="bottomLength">Bottom Length*</label>
          <input type="text" id="bottomLength" placeholder="In CM">
        </div>
        <div style="flex:1">
          <label for="details">Details</label>
          <textarea id="details"></textarea>
        </div>
      </div>

      <div class="row">
        <div style="flex:1">
          <label>Product Image (Front)*</label>
          <input type="file" id="productImage" accept="image/*" class="file-input">
        </div>
        <div style="flex:1">
          <label>Product Image (Back)</label>
          <input type="file" id="productImageBack" accept="image/*" class="file-input">
        </div>
      </div>

      <h3>Materials</h3>
      <div id="materials"></div>

      <h3>Attachments</h3>
      <div id="attachments"></div>

      <p id="msg"></p>
      <button id="submitBtn" type="submit">Save</button>
    </form>
  </div>

  <script>
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwpbCvnRpjaMIQi-SCWMNcIMgJXDqrCr3Y5K4uZ-OZpQ35GuBmoejLeC1MY5TvR0rMK/exec";

    function toBase64(file){
      return new Promise((resolve,reject)=>{
        const r=new FileReader();
        r.onload=()=>resolve(r.result);
        r.onerror=reject;
        r.readAsDataURL(file);
      });
    }

    function populateDropdowns(data){
      const map = {
        designerName : data.designers || [],
        unit         : data.units || [],
        productName  : data.products || [],
        printStyleId : data.printStyleIDs || [],
        printStyleNo : data.printStyleNos || []
      };
      Object.entries(map).forEach(([id, arr])=>{
        const el = document.getElementById(id);
        if(!el) return;
        el.innerHTML = "<option value=''>Select</option>" + arr.map(v=>`<option>${v}</option>`).join("");
      });
    }

    function buildDynamicRows(){
      const matDiv = document.getElementById("materials");
      const attDiv = document.getElementById("attachments");

      if(matDiv){
        matDiv.innerHTML="";
        for(let i=1;i<=5;i++){
          const row=document.createElement("div");
          row.className="row";
          row.innerHTML=`<input type="text" id="matName${i}" placeholder="Material ${i} Name">
                         <input type="text" id="matQty${i}" placeholder="Qty">`;
          matDiv.appendChild(row);
        }
      }

      if(attDiv){
        attDiv.innerHTML="";
        for(let i=1;i<=5;i++){
          const row=document.createElement("div");
          row.className="row";
          row.innerHTML=`<input type="text" id="attName${i}" placeholder="Attachment ${i} Name">
                         <input type="file" id="attPhoto${i}" accept="image/*" class="file-input">`;
          attDiv.appendChild(row);
        }
      }
    }

    // ---------- JSONP dropdown loader (no CORS) ----------
function loadDropdownsJSONP(){
  const msg = document.getElementById("msg");
  if (msg) msg.textContent = "Loading dropdowns...";

  // Create a unique callback name
  const cb = "cbDropdown_" + Date.now();

  // Define the callback BEFORE loading the script
  window[cb] = function (data) {
    try {
      const map = {
        designerName : data.designers || [],
        unit         : data.units || [],
        productName  : data.products || [],
        printStyleId : data.printStyleIDs || [],
        printStyleNo : data.printStyleNos || []
      };
      Object.entries(map).forEach(([id, arr])=>{
        const el = document.getElementById(id);
        if (!el) return;
        el.innerHTML = "<option value=''>Select</option>" +
          arr.map(v=>`<option>${String(v)}</option>`).join("");
      });

      if (msg) msg.textContent = ""; // clear loading text
    } catch (err) {
      console.error("Dropdown populate error:", err);
      if (msg) msg.textContent = "❌ Dropdown populate failed";
    } finally {
      // Clean up the script element and callback
      const scr = document.getElementById(cb);
      if (scr) scr.remove();
      delete window[cb];
    }
  };

  // Inject the script tag that calls Apps Script
  const s = document.createElement("script");
  s.id = cb;
  s.src = `${SCRIPT_URL}?action=getDropdownValues&callback=${cb}`;
  s.onerror = function() {
    if (msg) msg.textContent = "❌ Failed to load dropdowns (network)";
    delete window[cb];
    s.remove();
  };
  document.body.appendChild(s);
}


    async function gatherMaterialsAndAttachments(){
      const materials=[];
      for(let i=1;i<=5;i++){
        materials.push({
          name:document.getElementById("matName"+i)?.value||"",
          qty:document.getElementById("matQty"+i)?.value||""
        });
      }
      const attachments=[];
      for(let i=1;i<=5;i++){
        const f=document.getElementById("attPhoto"+i)?.files?.[0];
        let photoData="",photoType="",photoName="";
        if(f){
          photoData=await toBase64(f);
          photoType=f.type;
          photoName=f.name;
        }
        attachments.push({
          name:document.getElementById("attName"+i)?.value||"",
          photoData,photoType,photoName
        });
      }
      return {materials,attachments};
    }

    document.addEventListener("DOMContentLoaded",()=>{
      buildDynamicRows();
      loadDropdowns();

      const form=document.getElementById("entryForm");
      const btn=document.getElementById("submitBtn");
      const msg=document.getElementById("msg");

      form.addEventListener("submit",async e=>{
        e.preventDefault();
        btn.disabled=true;
        msg.textContent="Saving...";

        const fileFront=document.getElementById("productImage")?.files[0];
        const fileBack=document.getElementById("productImageBack")?.files[0];
        const productImageData=fileFront?await toBase64(fileFront):"";
        const productImageBackData=fileBack?await toBase64(fileBack):"";

        const {materials,attachments}=await gatherMaterialsAndAttachments();

        const formData={
          designerName:designerName.value,
          unit:unit.value,
          productName:productName.value,
          printStyleId:printStyleId.value,
          printStyleNo:printStyleNo.value,
          designNo:designNo.value,
          color:color.value,
          topLength:topLength.value,
          bottomLength:bottomLength.value,
          details:details.value,
          productImageData,
          productImageBackData,
          productImageType:fileFront?fileFront.type:"",
          productImageName:fileFront?fileFront.name:"",
          productImageBackType:fileBack?fileBack.type:"",
          productImageBackName:fileBack?fileBack.name:"",
          materials,attachments
        };

        try{
          const res=await fetch(SCRIPT_URL,{
            method:"POST",
            headers:{"Content-Type":"application/json"},
            body:JSON.stringify({action:"submitSample",formData})
          });
          const j=await res.json();
          if(j.success){
            msg.textContent="✅ Saved successfully!";
            form.reset();
            buildDynamicRows();
          }else{
            msg.textContent="❌ "+(j.error||"Failed to save");
          }
        }catch(err){
          console.error(err);
          msg.textContent="❌ "+err.message;
        }finally{
          btn.disabled=false;
        }
      });
    });
  

/* ===== HELPERS ===== */
function toBase64(file){
  return new Promise((resolve,reject)=>{
    const r=new FileReader();
    r.onload=()=>resolve(r.result);
    r.onerror=reject;
    r.readAsDataURL(file);
  });
}

function populateDropdowns(data){
  const map = {
    designerName : data.designers || [],
    unit         : data.units || [],
    productName  : data.products || [],
    printStyleId : data.printStyleIDs || [],
    printStyleNo : data.printStyleNos || []
  };
  Object.entries(map).forEach(([id, arr])=>{
    const el = document.getElementById(id);
    if(!el) return;
    el.innerHTML = "<option value=''>Select</option>" + arr.map(v=>`<option>${String(v)}</option>`).join("");
  });
}

/* keep your SCRIPT_URL, helpers, loadDropdowns, submit handler as-is */

/* REPLACE your buildDynamicRows() with this version */
function buildDynamicRows(){
  // --- Materials ---
  const matDiv = document.getElementById("materials");
  if (matDiv){
    matDiv.innerHTML = "";
    for (let i = 1; i <= 5; i++){
      const row = document.createElement("div");
      row.className = "row";

      const inName = document.createElement("input");
      inName.type = "text";
      inName.id = "matName"+i;
      inName.placeholder = "Material " + i + " Name";

      const inQty = document.createElement("input");
      inQty.type = "text";
      inQty.id = "matQty"+i;
      inQty.placeholder = "Qty";

      row.appendChild(inName);
      row.appendChild(inQty);
      matDiv.appendChild(row);
    }
  }

  // --- Attachments ---
  const attDiv = document.getElementById("attachments");
  if (attDiv){
    attDiv.innerHTML = "";
    for (let i = 1; i <= 5; i++){
      const row = document.createElement("div");
      row.className = "row";

      const inLabel = document.createElement("input");
      inLabel.type = "text";
      inLabel.id = "attName"+i;
      inLabel.placeholder = "Attachment " + i + " Name";

      const inFile = document.createElement("input");
      inFile.type = "file";
      inFile.id = "attPhoto"+i;
      inFile.accept = "image/*";
      inFile.className = "file-input";

      row.appendChild(inLabel);
      row.appendChild(inFile);
      attDiv.appendChild(row);
    }
  }
}

/* POST to Apps Script to get dropdown values */
function loadDropdownsJSONP(){
  const msg = document.getElementById("msg");
  if (msg) msg.textContent = "Loading dropdowns...";

  const cb = "cbDropdown_" + Date.now();
  window[cb] = function(data){
    try {
      populateDropdowns(data);
      if (msg) msg.textContent = "";
    } finally {
      const scr = document.getElementById(cb);
      if (scr) scr.remove();
      delete window[cb];
    }
  };

  const s = document.createElement("script");
  s.id = cb;
  s.src = `${SCRIPT_URL}?action=getDropdownValues&callback=${cb}`;
  s.onerror = () => {
    if (msg) msg.textContent = "❌ Failed to load dropdowns (network)";
    delete window[cb];
    s.remove();
  };
  document.body.appendChild(s);
}


/* Gather materials & attachments arrays */
async function gatherMaterialsAndAttachments(){
  const materials = [];
  for (let i=1;i<=5;i++){
    materials.push({
      name: (document.getElementById("matName"+i)?.value || ""),
      qty : (document.getElementById("matQty"+i)?.value || "")
    });
  }

  const attachments = [];
  for (let i=1;i<=5;i++){
    const name = (document.getElementById("attName"+i)?.value || "");
    const fInp = document.getElementById("attPhoto"+i);
    let photoData="", photoType="", photoName="";
    if (fInp && fInp.files && fInp.files[0]){
      const f = fInp.files[0];
      photoData = await toBase64(f);
      photoType = f.type;
      photoName = f.name;
    }
    attachments.push({ name, photoData, photoType, photoName });
  }

  return { materials, attachments };
}

/* ===== MAIN WIRING ===== */
document.addEventListener("DOMContentLoaded", () => {
  // build dynamic UI sections
  buildDynamicRows();
  // load dropdowns
  loadDropdownsJSONP().catch(err=>{
    console.error("Dropdown load failed:", err);
    const msgEl = document.getElementById("msg");
    if (msgEl) msgEl.textContent = "❌ Failed to load dropdowns";
  });

  // form submit handler (POST)
  const form = document.getElementById("entryForm");
  const btn  = document.getElementById("submitBtn");
  const msg  = document.getElementById("msg");

  form.addEventListener("submit", async (e)=>{
    e.preventDefault();
    if (btn) btn.disabled = true;
    if (msg) msg.textContent = "Saving...";

    const fileFront = document.getElementById("productImage")?.files[0] || null;
    const fileBack  = document.getElementById("productImageBack")?.files[0] || null;

    const productImageData     = fileFront ? await toBase64(fileFront) : "";
    const productImageBackData = fileBack  ? await toBase64(fileBack)  : "";

    const { materials, attachments } = await gatherMaterialsAndAttachments();

    const formData = {
      designerName: document.getElementById("designerName")?.value || "",
      unit: document.getElementById("unit")?.value || "",
      productName: document.getElementById("productName")?.value || "",
      printStyleId: document.getElementById("printStyleId")?.value || "",
      printStyleNo: document.getElementById("printStyleNo")?.value || "",
      designNo: document.getElementById("designNo")?.value || "",
      color: document.getElementById("color")?.value || "",
      topLength: document.getElementById("topLength")?.value || "",
      bottomLength: document.getElementById("bottomLength")?.value || "",
      details: document.getElementById("details")?.value || "",
      productImageData,
      productImageBackData,
      productImageType: fileFront ? fileFront.type : "",
      productImageName: fileFront ? fileFront.name : "",
      productImageBackType: fileBack ? fileBack.type : "",
      productImageBackName: fileBack ? fileBack.name : "",
      materials,
      attachments
    };

    try{
      const res = await fetch(SCRIPT_URL, {
        method:"POST",
        headers:{ "Content-Type":"application/json" },
        body: JSON.stringify({ action:"submitSample", formData })
      });
      const j = await res.json();
      if (j.success){
        if (msg) msg.textContent = "✅ Saved successfully!";
        form.reset();
        // rebuild rows to clear file inputs nicely
        buildDynamicRows();
      } else {
        if (msg) msg.textContent = "❌ " + (j.error || "Failed to save");
      }
    }catch(err){
      if (msg) msg.textContent = "❌ " + err.message;
      console.error(err);
    }finally{
      if (btn) btn.disabled = false;
    }
  });
});
    
</script>
  </body>
</html>
