<!DOCTYPE html>
<html>
  <head>
    <base target="_top">
    <style>
      body {
        font-family: 'Segoe UI', sans-serif;
        background: #f3f4f6;
        padding: 30px;
        color: #333;
      }

      .container {
        background: white;
        border-radius: 14px;
        padding: 30px 40px;
        max-width: 950px;
        margin: auto;
        box-shadow: 0 4px 10px rgba(0,0,0,0.08);
      }

      h2 {
        text-align: center;
        margin-bottom: 25px;
        font-weight: 600;
        color: #007bff;
      }

      table { width: 100%; border-collapse: collapse; }
      td { padding: 8px 10px; vertical-align: middle; }

      label {
        font-weight: 600;
        display: block;
        margin-bottom: 4px;
        color: #444;
      }

      input, select, textarea {
        width: 100%;
        padding: 8px;
        border-radius: 8px;
        border: 1px solid #ccc;
        box-sizing: border-box;
        transition: border-color 0.2s;
      }

      input:focus, select:focus, textarea:focus {
        outline: none;
        border-color: #007bff;
      }

      textarea { resize: vertical; }

      .section { margin-top: 25px; }

      h3 {
        background: #007bff;
        color: white;
        padding: 8px 12px;
        border-radius: 6px;
        font-size: 16px;
        margin-top: 30px;
      }

      .row {
        display: flex;
        gap: 10px;
        margin-bottom: 10px;
        align-items: center;
      }
      .row input[type="text"] { flex: 1 1 50%; }
      .row .file-box { flex: 1 1 50%; }
      .row .file-box input[type="file"] {
        width: 100%;
        background: #f8f9fa;
        padding: 10px;
        border-radius: 8px;
        border: 1px dashed #bbb;
        cursor: pointer;
      }
      .row .file-box input[type="file"]:hover { border-color: #007bff; }

      .file-input {
        background: #f8f9fa;
        padding: 10px;
        border-radius: 8px;
        border: 1px dashed #bbb;
      }
      .file-input:hover { border-color: #007bff; }

      button {
        margin-top: 25px;
        width: 100%;
        background-color: #007bff;
        color: white;
        border: none;
        padding: 12px;
        border-radius: 8px;
        font-size: 16px;
        cursor: pointer;
        transition: all 0.3s;
      }
      button.active { background-color: #28a745; }
      button:disabled { background: #ccc; cursor: not-allowed; }

      #msg {
        text-align: center;
        font-weight: 500;
        margin-top: 15px;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <form id="entryForm">
        <h2>Designer Sample Creation Form</h2>

        <table>
          <tr>
            <td><label>Designer Name*</label></td>
            <td><select id="designerName" required></select></td>
            <td><label>Unit*</label></td>
            <td><select id="unit" required></select></td>
          </tr>
          <tr>
            <td><label>Product Name*</label></td>
            <td><select id="productName" required></select></td>
            <td><label>Print Style ID*</label></td>
            <td><select id="printStyleId" required></select></td>
          </tr>
          <tr>
            <td><label>Print Style No*</label></td>
            <td><select id="printStyleNo" required></select></td>
            <td><label>Design No*</label></td>
            <td><input type="text" id="designNo" required></td>
          </tr>
          <tr>
            <td><label>Color*</label></td>
            <td><input type="text" id="color" required></td>
            <td><label>Top Length*</label></td>
            <td><input type="number" id="topLength" placeholder="In CM" step="0.01" required></td>
          </tr>
          <tr>
            <td><label>Bottom Length*</label></td>
            <td><input type="number" id="bottomLength" placeholder="In CM" step="0.01" required></td>
            <td><label>Details</label></td>
            <td><textarea id="details" rows="2"></textarea></td>
          </tr>
          <tr>
            <td><label>Product Image (Front)*</label></td>
            <td colspan="3"><input type="file" id="productImage" accept="image/*" required class="file-input"></td>
          </tr>
          <tr>
            <td><label>Product Image (Back)</label></td>
            <td colspan="3"><input type="file" id="productImageBack" accept="image/*" class="file-input"></td>
          </tr>
        </table>

        <h3>Materials</h3>
        <div id="materials"></div>

        <h3>Attachments</h3>
        <div id="attachments"></div>

        <button id="submitBtn" type="submit" disabled>Save</button>
        <p id="msg"></p>
      </form>
    </div>

    <script>
      document.addEventListener("DOMContentLoaded", () => {
        google.script.run.withSuccessHandler(populateDropdowns).getDropdownValues();
      });

      const requiredFields = [
        "designerName","unit","productName","printStyleId","printStyleNo",
        "designNo","color","topLength","bottomLength","productImage"
      ];
      const form = document.getElementById("entryForm");
      const btn = document.getElementById("submitBtn");
      const msg = document.getElementById("msg");

      // Build Materials
      const matDiv = document.getElementById("materials");
      for (let i=1;i<=5;i++) {
        const row = document.createElement("div");
        row.className = "row";
        row.innerHTML = `
          <input type="text" id="matName${i}" placeholder="Material ${i} Name">
          <input type="text" id="matQty${i}" placeholder="Qty">
        `;
        matDiv.appendChild(row);
      }

      // Build Attachments
      const attDiv = document.getElementById("attachments");
      for (let i=1;i<=5;i++) {
        const row = document.createElement("div");
        row.className = "row";
        row.innerHTML = `
          <input type="text" id="attName${i}" placeholder="Attachment ${i} Name">
          <input type="file" id="attPhoto${i}" accept="image/*" class="file-input">
        `;
        attDiv.appendChild(row);
      }

      function populateDropdowns(data) {
        fillDropdown("designerName", data.designers);
        fillDropdown("unit", data.units);
        fillDropdown("productName", data.products);
        fillDropdown("printStyleId", data.printStyleIDs);
        fillDropdown("printStyleNo", data.printStyleNos);
      }

      function fillDropdown(id, items) {
        const select = document.getElementById(id);
        select.innerHTML = '<option value="">Select...</option>';
        if (!Array.isArray(items)) return;
        items.forEach(v => {
          const opt = document.createElement("option");
          opt.value = v; opt.text = v;
          select.appendChild(opt);
        });
      }

      requiredFields.forEach(id => {
        document.getElementById(id).addEventListener("input", checkRequired);
        document.getElementById(id).addEventListener("change", checkRequired);
      });

      function checkRequired() {
        const allFilled = requiredFields.every(id => {
          const el = document.getElementById(id);
          return el.type === "file" ? el.files.length > 0 : el.value.trim() !== "";
        });
        btn.disabled = !allFilled;
        btn.classList.toggle("active", allFilled);
      }

      function toBase64(file) {
        return new Promise((resolve, reject) => {
          const reader = new FileReader();
          reader.readAsDataURL(file);
          reader.onload = () => resolve(reader.result);
          reader.onerror = error => reject(error);
        });
      }

      form.addEventListener("submit", async (e) => {
        e.preventDefault();
        msg.textContent = "Saving...";

        const fileFront = document.getElementById("productImage").files[0];
        const fileBack = document.getElementById("productImageBack").files[0];
        const productImageData = fileFront ? await toBase64(fileFront) : "";
        const productImageBackData = fileBack ? await toBase64(fileBack) : "";

        const materials = [];
        for (let i=1;i<=5;i++) {
          materials.push({
            name: document.getElementById("matName"+i).value,
            qty: document.getElementById("matQty"+i).value
          });
        }

        const attachments = [];
        for (let i=1;i<=5;i++) {
          const name = document.getElementById("attName"+i).value;
          const photoInput = document.getElementById("attPhoto"+i);
          let photoData="", photoType="", photoName="";
          if (photoInput.files.length>0) {
            const file = photoInput.files[0];
            photoData = await toBase64(file);
            photoType = file.type;
            photoName = file.name;
          }
          attachments.push({ name, photoData, photoType, photoName });
        }

        const formData = {
          designerName: designerName.value,
          unit: unit.value,
          productName: productName.value,
          printStyleId: printStyleId.value,
          printStyleNo: printStyleNo.value,
          designNo: designNo.value,
          color: color.value,
          topLength: topLength.value,
          bottomLength: bottomLength.value,
          details: details.value,
          productImageData,
          productImageBackData,
          productImageType: fileFront ? fileFront.type : "",
          productImageName: fileFront ? fileFront.name : "",
          productImageBackType: fileBack ? fileBack.type : "",
          productImageBackName: fileBack ? fileBack.name : "",
          materials,
          attachments
        };

        google.script.run
          .withSuccessHandler(r => {
            msg.textContent = r;
            form.reset();
            btn.disabled = true;
            btn.classList.remove("active");
          })
          .withFailureHandler(err => msg.textContent = "‚ùå " + err.message)
          .submitForm(formData);
      });
    </script>
  </body>
</html>
