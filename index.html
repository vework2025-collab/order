<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>VEWORK 2025 Orders</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 0; padding: 20px; }
    h1 { margin-top: 0; }
    table { width: 100%; border-collapse: collapse; margin-top: 10px; }
    th, td { border: 1px solid #ccc; padding: 6px 8px; text-align: left; font-size: 13px; }
    th { background: #f5f5f5; position: sticky; top: 0; }
    tr:nth-child(even) { background: #fafafa; }
    tr.overdue { background: #ffcccc !important; }     /* üî¥ overdue */
    tr.today { background: #fff3b0 !important; }       /* üü° due today */
    tr.future { background: #d7ffd7 !important; }      /* üü¢ upcoming */
    tr.nodate { background: #f0f0f0 !important; }      /* ‚ö™Ô∏è no date */
    .filters { display: flex; flex-wrap: wrap; gap: 20px; align-items: center; margin-bottom: 10px; }
    .filters div { display: flex; flex-direction: column; }
    .actions button { padding: 4px 10px; margin-right: 4px; cursor: pointer; }
    .status-cell input, .remark-cell input { width: 100%; box-sizing: border-box; }
  </style>
</head>
<body>
  <h1>VEWORK 2025 Order Dashboard</h1>

  <div class="filters">
    <div>
      <strong>Status</strong>
      <label><input type="checkbox" name="statusFilter" value=""> No Status</label>
      <label><input type="checkbox" name="statusFilter" value="Order Received"> Order Received</label>
      <label><input type="checkbox" name="statusFilter" value="For Work"> For Work</label>
      <label><input type="checkbox" name="statusFilter" value="Finishing"> Finishing</label>
      <label><input type="checkbox" name="statusFilter" value="Dispatch"> Dispatch</label>
    </div>

    <div>
      <strong>Branch</strong>
      <label><input type="checkbox" name="branchFilter" value="Branch Sales Order"> Branch</label>
      <label><input type="checkbox" name="branchFilter" value="Jaipur Sales Order"> Jaipur</label>
      <label><input type="checkbox" name="branchFilter" value="Jaipur Alterations"> Alterations</label>
      <label><input type="checkbox" name="branchFilter" value="Exhibition Sales Order"> Exhibition</label>
      <label><input type="checkbox" name="branchFilter" value="Wholesale Order"> Wholesale</label>
    </div>

    <div>
      <strong>Date Range</strong>
      <input type="date" id="startDate">
      <input type="date" id="endDate">
    </div>

    <div>
      <button onclick="applyFilters()">Apply Filters</button>
      <button onclick="loadData()">Reload All</button>
    </div>
  </div>

  <table id="ordersTable">
    <thead>
      <tr>
        <th>Order No</th>
        <th>Order Date</th>
        <th>Delivery Date</th>
        <th>Customer</th>
        <th>Branch</th>
        <th>Status</th>
        <th>Remark</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody id="tableBody"></tbody>
  </table>

  <script>
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzMu_iWnaHDBFyXjmVjjFahRpxiwo81BxvRx5fNQPOFK65XjOqtaFXinWFLqR4gluJE_Q/exec";
    let allOrdersData = [];

    async function loadData() {
      document.getElementById("tableBody").innerHTML = "<tr><td colspan='8'>Loading...</td></tr>";
      try {
        const res = await fetch(SCRIPT_URL);
        const json = await res.json();
        const arr = [];
        Object.keys(json).forEach(sheet => {
          const vals = json[sheet];
          const headers = vals[0];
          for (let i = 1; i < vals.length; i++) {
            const r = vals[i];
            arr.push({
              timestamp: r[1],
              orderNo: r[4],
              orderDate: r[5],
              deliveryDate: r[9],
              customerName: r[6],
              branch: sheet,
              status: r[22] || "",
              remark: r[15] || ""
            });
          }
        });
        allOrdersData = arr;
        applyFilters();
      } catch (err) {
        console.error("‚ùå loadData:", err);
        document.getElementById("tableBody").innerHTML = "<tr><td colspan='8'>Failed to load data</td></tr>";
      }
    }

    function applyFilters() {
      const selectedStatuses = Array.from(document.querySelectorAll('input[name="statusFilter"]:checked')).map(cb => cb.value.trim());
      const selectedBranches = Array.from(document.querySelectorAll('input[name="branchFilter"]:checked')).map(cb => cb.value.trim());
      const startDate = document.getElementById("startDate")?.value || "";
      const endDate = document.getElementById("endDate")?.value || "";
      const start = startDate ? new Date(startDate) : null;
      const end = endDate ? new Date(endDate) : null;

      let filtered = allOrdersData.filter(r => {
        const statusValue = (r.status || "").trim();
        const branchValue = (r.branch || "").trim();

        if (selectedStatuses.length) {
          if (!selectedStatuses.includes(statusValue) &&
              !(statusValue === "" && selectedStatuses.includes(""))) return false;
        }
        if (selectedBranches.length && !selectedBranches.includes(branchValue)) return false;

        if (start || end) {
          const od = r.orderDate ? new Date(r.orderDate) : null;
          if (od) {
            if (start && od < start) return false;
            if (end && od > end) return false;
          }
        }
        return true;
      });

      filtered.sort((a,b)=> new Date(b.timestamp||0) - new Date(a.timestamp||0));
      renderOrders(filtered);
    }

    function renderOrders(rows) {
      const tbody = document.getElementById("tableBody");
      if (!rows.length) {
        tbody.innerHTML = "<tr><td colspan='8'>No orders found</td></tr>";
        return;
      }
      const today = new Date();
      tbody.innerHTML = rows.map(r => {
        let cls = "nodate";
        if (r.deliveryDate) {
          const dd = new Date(r.deliveryDate);
          dd.setHours(0,0,0,0); today.setHours(0,0,0,0);
          if (dd < today) cls = "overdue";
          else if (dd.getTime() === today.getTime()) cls = "today";
          else cls = "future";
        }
        return `
          <tr class="${cls}">
            <td>${r.orderNo || ""}</td>
            <td>${r.orderDate || ""}</td>
            <td>${r.deliveryDate || ""}</td>
            <td>${r.customerName || ""}</td>
            <td>${r.branch || ""}</td>
            <td class="status-cell"><input value="${r.status || ""}" data-order="${r.orderNo}" data-branch="${r.branch}"></td>
            <td class="remark-cell"><input value="${r.remark || ""}" data-order="${r.orderNo}" data-branch="${r.branch}"></td>
            <td class="actions">
              <button onclick="saveRow('${r.branch}','${r.orderNo}')">Save</button>
              <button onclick="printRow('${r.branch}','${r.orderNo}')">Print</button>
            </td>
          </tr>`;
      }).join("");
    }

    async function saveRow(sheetName, orderNo) {
      const row = document.querySelector(`input[data-order="${orderNo}"][data-branch="${sheetName}"]`);
      const status = row.closest("tr").querySelector(".status-cell input").value;
      const remark = row.closest("tr").querySelector(".remark-cell input").value;
      const payload = { sheetName, orderNo, status, remark, action: "save" };

      try {
        const res = await fetch(SCRIPT_URL, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload)
        });
        const json = await res.json();
        if (json.success) alert("‚úÖ Saved!");
        else alert("‚ùå " + json.error);
      } catch (err) {
        console.error("‚ùå Save error:", err);
        alert("‚ùå Failed to fetch (save)");
      }
    }

    async function printRow(sheetName, orderNo) {
      try {
        const res = await fetch(SCRIPT_URL, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ sheetName, orderNo, action: "print" })
        });
        const json = await res.json();
        if (json.success && json.pdf) {
          const blob = base64ToBlob(json.pdf, "application/pdf");
          const url = URL.createObjectURL(blob);
          window.open(url, "_blank");
        } else {
          alert("‚ùå " + (json.error || "Print failed"));
        }
      } catch (err) {
        console.error("‚ùå Print error:", err);
        alert("‚ùå Failed to fetch (print)");
      }
    }

    function base64ToBlob(b64, type) {
      const byteChars = atob(b64);
      const byteNums = new Array(byteChars.length);
      for (let i = 0; i < byteChars.length; i++) byteNums[i] = byteChars.charCodeAt(i);
      return new Blob([new Uint8Array(byteNums)], { type });
    }

    loadData();
  </script>
</body>
</html>
