<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>Vasansi Enterprise Application â€” Dashboard</title>
<link rel="stylesheet" href="assets/style.css">
</head>
<body>
<div class="app">
  <div class="topbar">
    <div class="title">Vasansi Enterprise Application</div>
    <div class="user">Hemant Solanki â–¼</div>
  </div>

  <!-- Sidebar -->
  <aside class="sidebar">
    <ul class="nav">
      <li><a href="index.html">ğŸ  <span class="label">Dashboard</span></a></li>
      <li><a href="dispatch.html">ğŸ“¦ <span class="label">Dispatch</span></a></li>
      <li><a href="jobwork.html">ğŸ§µ <span class="label">Job Work</span></a></li>
      <li class="section-title">Order</li>
      <li>
        <a href="orders.html">ğŸ“‹ <span class="label">All Orders</span></a>
        <ul class="submenu">
          <li><a href="orders.html#Branch%20Sales%20Order">Branch Sales Order</a></li>
          <li><a href="orders.html#Jaipur%20Sales%20Order">Jaipur Sales Order</a></li>
          <li><a href="orders.html#Jaipur%20Alterations">Jaipur Alterations</a></li>
          <li><a href="orders.html#Exhibition%20Sales%20Order">Exhibition Sales Order</a></li>
          <li><a href="orders.html#Wholesale%20Order">Wholesale Order</a></li>
        </ul>
      </li>
      <li><a href="production.html">ğŸ­ <span class="label">Production</span></a></li>
      <li><a href="reports.html">ğŸ“‘ <span class="label">Reports</span></a></li>
    </ul>
  </aside>

  <!-- Content -->
  <main class="content">
    <div class="kpis" id="kpiRow">
      <div class="kpi"><div class="label">Total Orders</div><div class="value" id="kpiTotal">â€“</div><div class="sub" id="kpiRange"></div></div>
      <div class="kpi"><div class="label">Ready For Delivery</div><div class="value" id="kpiRFD">â€“</div><div class="sub">status = Ready For Delivery</div></div>
      <div class="kpi"><div class="label">In Production</div><div class="value" id="kpiInProd">â€“</div><div class="sub">not Delivered / Cancelled</div></div>
      <div class="kpi"><div class="label">Delivered</div><div class="value" id="kpiDelivered">â€“</div><div class="sub">status = Delivered</div></div>
    </div>

    <div class="card">
      <h2>Quick Filters</h2>
      <div class="controls">
        <label>Order Date <input type="date" id="dStart"> to <input type="date" id="dEnd"></label>
        <label>Sheet <select id="sheetFilter"></select></label>
        <label>Unit <select id="unitFilter"></select></label>
        <button class="btn" id="applyDash">Apply</button>
        <button id="resetDash">Reset</button>
      </div>
      <div class="chips" id="topStatuses"></div>
    </div>

    <div class="card">
      <h2>Branch-wise Status Count (Sheet Name)</h2>
      <div style="overflow:auto;">
        <table class="table" id="branchTable"></table>
      </div>
    </div>

    <div class="card">
      <h2>Unit-wise Status Count</h2>
      <div style="overflow:auto;">
        <table class="table" id="unitTable"></table>
      </div>
    </div>
  </main>
</div>

<script src="assets/app.js"></script>
<script>
/* === CONFIG (same as orders) === */
const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbyE5VORxmizRnO1Cnw0LVZjbl_f_ZBOgadrGynkJLfsl5QPs1ocPhDkOqpi_jH1tTZt/exec";
const FIXED_SHEETS = [
  "Branch Sales Order","Jaipur Sales Order","Jaipur Alterations","Exhibition Sales Order","Wholesale Order"
];
const INCLUDED_COLUMNS = [
  "Timestamp","Sheet Name","Order No","Order Date","Delivery Date","Item","Design No","Unit",
  "Product Image","Order Form Photo","Remark","Status","Jobber Name"
];
const ALL_STATUSES = [
  "", "Order Received","Dye","Print Process","Print Received","For Work",
  "From Work Received","Send To Party","Received From Party","Stitching","Finishing",
  "Dispatch To Warehouse","Received At Warehouse","Send To D69","Received At D69",
  "Ready For Delivery","Billed","Tracking Updated","Hand Delivery","Delivered","Cancelled"
];

let headers=[], rows=[], dashRows=[];

const clean = arr => Array.isArray(arr)?arr.filter(r=>Array.isArray(r)).map(r=>r.map(c=>c==null?"":String(c))):[];

async function loadData(){
  const res = await fetch(SCRIPT_URL);
  const data = await res.json();
  const combined = combineSheetsObject(data);
  headers = combined[0].map(h=>h||"");
  rows = clean(combined.slice(1)).sort((a,b)=>new Date(b[0])-new Date(a[0]));
  dashRows = rows.slice(); // working copy
  populateQuickFilters();
  refreshDashboard();
}

function combineSheetsObject(obj){
  const out=[INCLUDED_COLUMNS];
  FIXED_SHEETS.forEach(sheet=>{
    const sd=obj[sheet]; if(!Array.isArray(sd)||sd.length<2) return;
    const hs=sd[0];
    sd.slice(1).forEach(r=>{
      const mapped=INCLUDED_COLUMNS.map(h=>{
        const ix=hs.indexOf(h); return ix===-1?"":(r[ix]||"");
      });
      const ts=hs.indexOf("Timestamp");
      mapped[0]=ts>=0?r[ts]:"";
      mapped[1]=sheet;
      out.push(mapped);
    });
  });
  return out;
}

function seedCounts(){ return Object.fromEntries(ALL_STATUSES.map(s=>[s,0])); }

function buildCounts(data, idxKey){
  const idxStatus=headers.indexOf("Status");
  const map={};
  data.forEach(r=>{
    const key=r[idxKey]||"(unknown)";
    const st=r[idxStatus]||"";
    if(!map[key]) map[key]=seedCounts();
    map[key][st]=(map[key][st]||0)+1;
  });
  return map;
}

function renderCountTable(tableId, firstCol, countsObj){
  const tbl=document.getElementById(tableId);
  let thead=`<thead><tr><th>${firstCol}</th>`;
  ALL_STATUSES.forEach(s=>thead+=`<th>${s||"(blank)"}</th>`); thead+=`<th>Total</th></tr></thead>`;
  let tbody="<tbody>";
  const entries=Object.entries(countsObj);
  const totals=entries.map(([_,o])=>Object.values(o).reduce((a,b)=>a+b,0));
  const maxTotal=Math.max(1,...totals);
  entries.forEach(([k,o])=>{
    const total=Object.values(o).reduce((a,b)=>a+b,0);
    tbody+=`<tr><td>${k}</td>`;
    ALL_STATUSES.forEach(s=>
      const val = o[s] || 0;
const encodedStatus = encodeURIComponent(s);
const encodedKey = encodeURIComponent(k);
tbody += `<td class="clickable" 
  onclick="openOrders('${firstCol}','${encodedKey}','${encodedStatus}')">${val}</td>`;
);
    const pct=Math.round(total/maxTotal*100);
    tbody+=`<td>${total}<div class="bar"><span style="width:${pct}%"></span></div></td></tr>`;
  });
  // grand total
  const grand=seedCounts(); let gTot=0;
  entries.forEach(([_,o])=>{ ALL_STATUSES.forEach(s=>grand[s]+=o[s]||0); gTot+=Object.values(o).reduce((a,b)=>a+b,0); });
  tbody+=`<tr><th>Total</th>`; ALL_STATUSES.forEach(s=>tbody+=`<th>${grand[s]}</th>`); tbody+=`<th>${gTot}</th></tr>`;
  tbody+="</tbody>";
  tbl.innerHTML=thead+tbody;
}
function openOrders(type, key, status){
  let hash = "";
  if (type === "Branch") hash = `#sheet=${key}&status=${status}`;
  else if (type === "Unit") hash = `#unit=${key}&status=${status}`;
  window.open(`orders.html${hash}`, "_blank"); // open in new tab
}

function refreshDashboard(){
  // KPI calculations
  const idxStatus=headers.indexOf("Status");
  const idxOrderDate=headers.indexOf("Order Date");
  const total=dashRows.length;
 const stVal = r => (r[idxStatus]||"").trim();
const sets = {
  inProd: ["","Order Received","Dye","Print Process","Print Received","For Work",
           "From Work Received","Send To Party","Received From Party","Stitching","Finishing"],
  rfd: ["Dispatch To Warehouse","Received At Warehouse","Send To D69","Received At D69",
        "Ready For Delivery","Billed"],
  delivered: ["Tracking Updated","Hand Delivery","Delivered","Cancelled"]
};
const inProd = dashRows.filter(r => sets.inProd.includes(stVal(r))).length;
const rfd    = dashRows.filter(r => sets.rfd.includes(stVal(r))).length;
const delivered = dashRows.filter(r => sets.delivered.includes(stVal(r))).length;


  document.getElementById("kpiTotal").textContent=total;
  document.getElementById("kpiDelivered").textContent=delivered;
  document.getElementById("kpiRFD").textContent=rfd;
  document.getElementById("kpiInProd").textContent=inProd;

  // show current date span (min..max)
  const dates = dashRows.map(r=>new Date(r[idxOrderDate]||"")).filter(d=>!isNaN(d));
  if(dates.length){
    const min = new Date(Math.min.apply(null, dates));
    const max = new Date(Math.max.apply(null, dates));
    document.getElementById("kpiRange").textContent =
      min.toLocaleDateString("en-GB",{day:"2-digit",month:"short",year:"numeric"}) + " â€“ " +
      max.toLocaleDateString("en-GB",{day:"2-digit",month:"short",year:"numeric"});
  } else {
    document.getElementById("kpiRange").textContent = "";
  }

  // top statuses chips
  const counts = dashRows.reduce((m,r)=>{
    const st=r[idxStatus]||""; m[st]=(m[st]||0)+1; return m;
  },{});
  const top = Object.entries(counts).sort((a,b)=>b[1]-a[1]).slice(0,8);
  document.getElementById("topStatuses").innerHTML =
    top.map(([s,c])=>`<span class="chip">${(s||"(blank)")} â€” ${c}</span>`).join("");

  // tables
  const idxSheet=headers.indexOf("Sheet Name");
  const idxUnit=headers.indexOf("Unit");
  renderCountTable("branchTable","Branch", buildCounts(dashRows, idxSheet));
  renderCountTable("unitTable","Unit", buildCounts(dashRows, idxUnit));
}

/* Quick filters (dashboard-only) */
function populateQuickFilters(){
  const idxSheet=headers.indexOf("Sheet Name");
  const idxUnit=headers.indexOf("Unit");
  const sheets=[...new Set(rows.map(r=>r[idxSheet]).filter(Boolean))];
  const units=[...new Set(rows.map(r=>r[idxUnit]).filter(Boolean))];

  sheetFilter.innerHTML = `<option value="">All</option>` + sheets.map(s=>`<option>${s}</option>`).join("");
  unitFilter.innerHTML  = `<option value="">All</option>` + units.map(u=>`<option>${u}</option>`).join("");

  applyDash.addEventListener("click", ()=>{
    const s=sheetFilter.value, u=unitFilter.value, ds=dStart.value, de=dEnd.value;
    const idxOrderDate=headers.indexOf("Order Date");
    dashRows = rows.filter(r=>{
      const okS = !s || r[idxSheet]===s;
      const okU = !u || r[idxUnit]===u;
      const d = new Date(r[idxOrderDate]||"");
      const okD1 = !ds || d>=new Date(ds);
      const okD2 = !de || d<=new Date(de+"T23:59:59");
      return okS && okU && okD1 && okD2;
    });
    refreshDashboard();
  });

  resetDash.addEventListener("click", ()=>{
    dStart.value=""; dEnd.value=""; sheetFilter.value=""; unitFilter.value="";
    dashRows = rows.slice(); refreshDashboard();
  });
}

loadData();
  // ===== Simple Table Sorting =====
document.addEventListener("click", e=>{
  const th = e.target.closest("th");
  if (!th || !th.parentNode.parentNode.parentNode.id.includes("Table")) return;
  const table = th.closest("table");
  const tbody = table.querySelector("tbody");
  const index = [...th.parentNode.children].indexOf(th);
  const asc = !th.classList.contains("sort-asc");
  [...table.querySelectorAll("th")].forEach(h=>h.classList.remove("sort-asc","sort-desc"));
  th.classList.add(asc?"sort-asc":"sort-desc");

  const rows = [...tbody.querySelectorAll("tr")];
  rows.sort((a,b)=>{
    const A = a.children[index].innerText.trim();
    const B = b.children[index].innerText.trim();
    const nA = parseFloat(A.replace(/[^0-9.]/g,"")), nB = parseFloat(B.replace(/[^0-9.]/g,""));
    return (isNaN(nA)||isNaN(nB)?A.localeCompare(B):nA-nB)*(asc?1:-1);
  });
  rows.forEach(r=>tbody.appendChild(r));
});

</script>
</body>
</html>


