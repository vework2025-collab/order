<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>Vasansi Enterprise Application â€” Dashboard</title>
<link rel="stylesheet" href="assets/style.css">
<link rel="icon" href="data:,">
<style>
  .kpis { display:grid; grid-template-columns:repeat(auto-fit,minmax(180px,1fr)); gap:12px; margin-bottom:14px; }
  .kpi { background:#fff; border:1px solid #ddd; border-radius:10px; padding:14px; box-shadow:0 1px 2px rgba(0,0,0,.05); }
  .kpi .label{ font-size:12px; color:#666; margin-bottom:6px; }
  .kpi .value{ font-size:22px; font-weight:700; }
  .kpi .sub  { font-size:12px; color:#888; margin-top:6px; }
  .chips{ display:flex; flex-wrap:wrap; gap:6px; }
  .chip{ border:1px solid #e0e0e0; padding:4px 8px; border-radius:999px; background:#fff; font-size:12px; }
  .table { width:100%; border-collapse:collapse; background:#fff; }
  .table th, .table td { border:1px solid #e3e3e3; padding:6px 8px; font-size:13px; white-space:nowrap; }
  .table th { background:#f5f6f7; cursor:pointer; }
  .bar{ height:8px; background:#e9ecef; border-radius:4px; overflow:hidden; min-width:120px; }
  .bar>span{ display:block; height:100%; background:#007bff; }
  .clickable { cursor:pointer; color:#007bff; font-weight:600; }
  .clickable:hover { text-decoration: underline; }
</style>
</head>
<body>
<div class="app">
  <div class="topbar">
    <div class="title">Vasansi Enterprise Application</div>
    <div class="user">Hemant Solanki â–¼</div>
  </div>

  <aside class="sidebar">
    <ul class="nav">
      <li><a href="index.html">ğŸ  <span class="label">Dashboard</span></a></li>
      <li><a href="dispatch.html">ğŸ“¦ <span class="label">Dispatch</span></a></li>
      <li><a href="jobwork.html">ğŸ§µ <span class="label">Job Work</span></a></li>
      <li class="section-title">Order</li>
      <li>
        <a href="orders.html">ğŸ“‹ <span class="label">All Orders</span></a>
        <ul class="submenu">
          <li><a href="orders.html#Branch%20Sales%20Order">Branch Sales Order</a></li>
          <li><a href="orders.html#Jaipur%20Sales%20Order">Jaipur Sales Order</a></li>
          <li><a href="orders.html#Jaipur%20Alterations">Jaipur Alterations</a></li>
          <li><a href="orders.html#Exhibition%20Sales%20Order">Exhibition Sales Order</a></li>
          <li><a href="orders.html#Wholesale%20Order">Wholesale Order</a></li>
        </ul>
      </li>
      <li><a href="production.html">ğŸ­ <span class="label">Production</span></a></li>
      <li><a href="reports.html">ğŸ“‘ <span class="label">Reports</span></a></li>
    </ul>
  </aside>

  <main class="content">
    <div class="kpis">
      <div class="kpi"><div class="label">Total Orders</div><div class="value" id="kpiTotal">â€“</div><div class="sub" id="kpiRange"></div></div>
      <div class="kpi"><div class="label">In Production</div><div class="value" id="kpiInProd">â€“</div><div class="sub">blank + early statuses</div></div>
      <div class="kpi"><div class="label">Ready For Delivery</div><div class="value" id="kpiRFD">â€“</div><div class="sub">Dispatchâ†’Billed group</div></div>
      <div class="kpi"><div class="label">Delivered</div><div class="value" id="kpiDelivered">â€“</div><div class="sub">Tracking/Hand/Delivered/Cancelled</div></div>
    </div>

    <div class="card">
      <h2>Quick Filters</h2>
      <div class="controls">
        <label>Order Date <input type="date" id="dStart"> to <input type="date" id="dEnd"></label>
        <label>Sheet <select id="sheetFilter"></select></label>
        <label>Unit <select id="unitFilter"></select></label>
        <button class="btn" id="applyDash">Apply</button>
        <button id="resetDash">Reset</button>
      </div>
      <div class="chips" id="topStatuses"></div>
    </div>

    <div class="card">
      <h2>Branch-wise Status Count</h2>
      <div style="overflow:auto;">
        <table class="table" id="branchTable"></table>
      </div>
    </div>

    <div class="card">
      <h2>Unit-wise Status Count</h2>
      <div style="overflow:auto;">
        <table class="table" id="unitTable"></table>
      </div>
    </div>
  </main>
</div>

<script>
const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbyE5VORxmizRnO1Cnw0LVZjbl_f_ZBOgadrGynkJLfsl5QPs1ocPhDkOqpi_jH1tTZt/exec";
const SHEETS = ["Branch Sales Order","Jaipur Sales Order","Jaipur Alterations","Exhibition Sales Order","Wholesale Order"];
const INCLUDED = ["Timestamp","Sheet Name","Order No","Order Date","Delivery Date","Item","Design No","Unit","Product Image","Order Form Photo","Remark","Status","Jobber Name"];
const ALL_STATUSES = ["","Order Received","Dye","Print Process","Print Received","For Work","From Work Received","Send To Party","Received From Party","Stitching","Finishing","Dispatch To Warehouse","Received At Warehouse","Send To D69","Received At D69","Ready For Delivery","Billed","Tracking Updated","Hand Delivery","Delivered","Cancelled"];

const sets = {
  inProd: ["","Order Received","Dye","Print Process","Print Received","For Work","From Work Received","Send To Party","Received From Party","Stitching","Finishing"],
  rfd: ["Dispatch To Warehouse","Received At Warehouse","Send To D69","Received At D69","Ready For Delivery","Billed"],
  delivered: ["Tracking Updated","Hand Delivery","Delivered","Cancelled"]
};

let headers=[], rows=[], dashRows=[];

function clean(arr){
  return Array.isArray(arr)?arr.filter(r=>Array.isArray(r)).map(r=>r.map(c=>c==null?"":String(c))):[];
}

async function loadData(){
  try{
    const res=await fetch(`${SCRIPT_URL}?t=${Date.now()}`);
    const json=await res.json();
    // flatten
    let out=[];
    SHEETS.forEach(name=>{
      const d=json[name]; if(!Array.isArray(d)||d.length<2) return;
      const hs=d[0];
      d.slice(1).forEach(r=>{
        const obj={};
        INCLUDED.forEach(h=>{
          const idx=hs.indexOf(h); obj[h]= idx===-1 ? "" : (r[idx]??"");
        });
        obj["Sheet Name"]=name;
        out.push(obj);
      });
    });

    headers = INCLUDED.slice();
    rows = out.sort((a,b)=>new Date(b["Timestamp"]||0)-new Date(a["Timestamp"]||0));
    dashRows = rows.slice();

    populateQuickFilters();
    refreshDashboard();
  }catch(e){
    console.error(e);
    document.getElementById("branchTable").innerHTML = `<tr><td style="color:#b00020;font-weight:600">âŒ ${e.message}</td></tr>`;
  }
}

function populateQuickFilters(){
  const sheets=[...new Set(rows.map(r=>r["Sheet Name"]).filter(Boolean))];
  const units=[...new Set(rows.map(r=>r["Unit"]).filter(Boolean))];
  sheetFilter.innerHTML = `<option value="">All</option>` + sheets.map(s=>`<option>${s}</option>`).join("");
  unitFilter.innerHTML  = `<option value="">All</option>` + units.map(u=>`<option>${u}</option>`).join("");

  applyDash.onclick = ()=>{
    const s=sheetFilter.value, u=unitFilter.value, ds=dStart.value, de=dEnd.value;
    dashRows = rows.filter(r=>{
      const okS = !s || r["Sheet Name"]===s;
      const okU = !u || r["Unit"]===u;
      const d = new Date(r["Order Date"]||"");
      const okD1 = !ds || d>=new Date(ds);
      const okD2 = !de || d<=new Date(de+"T23:59:59");
      return okS && okU && okD1 && okD2;
    });
    refreshDashboard();
  };
  resetDash.onclick = ()=>{
    dStart.value=""; dEnd.value=""; sheetFilter.value=""; unitFilter.value="";
    dashRows = rows.slice();
    refreshDashboard();
  };
}

function stVal(r){ return (r["Status"]||"").trim(); }

function refreshDashboard(){
  const total = dashRows.length;
  const inProd = dashRows.filter(r=>sets.inProd.includes(stVal(r))).length;
  const rfd    = dashRows.filter(r=>sets.rfd.includes(stVal(r))).length;
  const delivered = dashRows.filter(r=>sets.delivered.includes(stVal(r))).length;

  kpiTotal.textContent = total;
  kpiInProd.textContent = inProd;
  kpiRFD.textContent = rfd;
  kpiDelivered.textContent = delivered;

  const ods = dashRows.map(r=>new Date(r["Order Date"]||"")).filter(d=>!isNaN(d));
  kpiRange.textContent = ods.length
    ? new Date(Math.min(...ods)).toLocaleDateString("en-GB",{day:"2-digit",month:"short",year:"numeric"}) + " â€“ " +
      new Date(Math.max(...ods)).toLocaleDateString("en-GB",{day:"2-digit",month:"short",year:"numeric"})
    : "";

  const counts = dashRows.reduce((m,r)=>{ const s=stVal(r); m[s]=(m[s]||0)+1; return m; },{});
  const top = Object.entries(counts).sort((a,b)=>b[1]-a[1]).slice(0,8);
  topStatuses.innerHTML = top.map(([s,c])=>`<span class="chip">${s||"(blank)"} â€” ${c}</span>`).join("");

  const bySheet = groupCounts(dashRows, "Sheet Name");
  const byUnit  = groupCounts(dashRows, "Unit");
  renderCountTable("branchTable","Branch", bySheet);
  renderCountTable("unitTable","Unit", byUnit);

  // enable sorting on both tables
  enableTableSorting("branchTable");
  enableTableSorting("unitTable");
}

function groupCounts(data, key){
  const map = {};
  data.forEach(r=>{
    const k = r[key] || "(unknown)";
    const s = stVal(r);
    if(!map[k]) map[k] = Object.fromEntries(ALL_STATUSES.map(x=>[x,0]));
    map[k][s] = (map[k][s]||0) + 1;
  });
  return map;
}

function renderCountTable(tableId, firstCol, countsObj){
  const tbl=document.getElementById(tableId);
  let thead = `<thead><tr><th>${firstCol}</th>`;
  ALL_STATUSES.forEach(s=> thead += `<th>${s||"(blank)"}</th>`);
  thead += `<th>Total</th></tr></thead>`;

  const entries = Object.entries(countsObj);
  const totals = entries.map(([_,o])=>Object.values(o).reduce((a,b)=>a+b,0));
  const maxT = Math.max(1, ...totals);

  let tbody = "<tbody>";
  entries.forEach(([k,o])=>{
    const t = Object.values(o).reduce((a,b)=>a+b,0);
    tbody += `<tr><td>${k}</td>`;
    ALL_STATUSES.forEach(s=>{
      const val = o[s]||0;
      const eKey = encodeURIComponent(k), eStat = encodeURIComponent(s);
      const click = firstCol==="Branch"
        ? `openOrders('sheet','${eKey}','${eStat}')`
        : `openOrders('unit','${eKey}','${eStat}')`;
      tbody += `<td class="clickable" onclick="${click}">${val}</td>`;
    });
    const pct = Math.round(t/maxT*100);
    tbody += `<td>${t}<div class="bar"><span style="width:${pct}%"></span></div></td></tr>`;
  });

  // grand total
  const grand = Object.fromEntries(ALL_STATUSES.map(s=>[s,0])); let gTot=0;
  entries.forEach(([_,o])=>{ ALL_STATUSES.forEach(s=> grand[s]+=o[s]||0); gTot += Object.values(o).reduce((a,b)=>a+b,0); });
  tbody += `<tr><th>Total</th>${ALL_STATUSES.map(s=>`<th>${grand[s]}</th>`).join("")}<th>${gTot}</th></tr>`;
  tbody += "</tbody>";

  tbl.innerHTML = thead + tbody;
}

function openOrders(kind, key, status){
  const p = new URLSearchParams();
  if (kind==="sheet") p.set("sheet", key);
  if (kind==="unit")  p.set("unit", key);
  p.set("status", status);
  window.open(`orders.html#${p.toString()}`, "_blank");
}

/* generic sort for dashboard tables */
function enableTableSorting(tableId){
  const tbl = document.getElementById(tableId);
  tbl.querySelectorAll("th").forEach((th,idx)=>{
    th.onclick = ()=>{
      // skip first col label when needed? here we sort by clicked col anyway
      const tbody = tbl.querySelector("tbody");
      const rows = [...tbody.querySelectorAll("tr")];
      const asc = !th.classList.contains("sort-asc");
      tbl.querySelectorAll("th").forEach(h=>h.classList.remove("sort-asc","sort-desc"));
      th.classList.add(asc?"sort-asc":"sort-desc");

      rows.sort((a,b)=>{
        const A = a.children[idx]?.innerText.trim() ?? "";
        const B = b.children[idx]?.innerText.trim() ?? "";
        const nA = parseFloat(A.replace(/[^0-9.]/g,""));
        const nB = parseFloat(B.replace(/[^0-9.]/g,""));
        const cmp = (isNaN(nA)||isNaN(nB)) ? A.localeCompare(B) : (nA-nB);
        return asc ? cmp : -cmp;
      });
      rows.forEach(r=>tbody.appendChild(r));
    };
  });
}

loadData();
</script>
</body>
</html>
