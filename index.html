<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>Vasansi Enterprise Application ‚Äî Dashboard</title>
<link rel="stylesheet" href="assets/style.css">
<link rel="icon" href="data:,">
<style>
  .kpis { display:grid; grid-template-columns:repeat(auto-fit,minmax(180px,1fr)); gap:12px; margin-bottom:14px; }
  .kpi { background:#fff; border:1px solid #ddd; border-radius:10px; padding:14px; box-shadow:0 1px 2px rgba(0,0,0,.05); }
  .kpi .label{ font-size:12px; color:#666; margin-bottom:6px; }
  .kpi .value{ font-size:22px; font-weight:700; }
  .kpi .sub  { font-size:12px; color:#888; margin-top:6px; }
  .table { width:100%; border-collapse:collapse; background:#fff; }
  .table th, .table td { border:1px solid #e3e3e3; padding:6px 8px; font-size:13px; white-space:nowrap; }
  .table th { background:#f5f6f7; cursor:pointer; }
  .bar{ height:8px; background:#e9ecef; border-radius:4px; overflow:hidden; min-width:120px; }
  .bar>span{ display:block; height:100%; background:#007bff; }
  .clickable { cursor:pointer; color:#007bff; font-weight:600; }
  .clickable:hover { text-decoration: underline; }
  .controls { display:flex; flex-wrap:wrap; gap:8px; margin:10px 0; align-items:center; }
</style>
</head>
<body>
<div class="app">
  <div class="topbar">
    <div class="title">Vasansi Enterprise Application</div>
    <div class="user">Hemant Solanki ‚ñº</div>
  </div>

  <aside class="sidebar">
    <ul class="nav">
      <li><a href="index.html">üè† <span class="label">Dashboard</span></a></li>
      <li><a href="dispatch.html">üì¶ <span class="label">Dispatch</span></a></li>
      <a href="orders.html">üìã <span class="label">All Orders</span></a>
        <ul class="submenu">
          <li><a href="Job-Issue">Branch Sales Order</a></li>
         </ul>
      <li class="section-title">Order</li>
      <li>
        <a href="orders.html">üìã <span class="label">All Orders</span></a>
        <ul class="submenu">
          <li><a href="orders.html#Branch%20Sales%20Order">Branch Sales Order</a></li>
          <li><a href="orders.html#Jaipur%20Sales%20Order">Jaipur Sales Order</a></li>
          <li><a href="orders.html#Jaipur%20Alterations">Jaipur Alterations</a></li>
          <li><a href="orders.html#Exhibition%20Sales%20Order">Exhibition Sales Order</a></li>
          <li><a href="orders.html#Wholesale%20Order">Wholesale Order</a></li>
        </ul>
      </li>
      <li>
  <a href="#">üè≠ <span class="label">Production</span></a>
  <ul class="submenu">
    <li><a href="production.html">Production Overview</a></li>
    <li>
  <a href="https://script.google.com/macros/s/AKfycbwdBfo7pkIp6qijqbm6OFRVwuiupx_Y6-B00nqDm69MqQp9FXRw0cpi0vC_vf_rm-Rv/exec" 
     target="_blank">
     Sample Form
  </a>
</li>

    <li><a href="sample_view.html">Sample View</a></li>
  </ul>
</li>

      <li><a href="reports.html">üìë <span class="label">Reports</span></a></li>
    </ul>
  </aside>

  <main class="content">
    <div class="kpis">
      <div class="kpi"><div class="label">Total Orders</div><div class="value" id="kpiTotal">‚Äì</div><div class="sub" id="kpiRange"></div></div>
      <div class="kpi"><div class="label">In Production</div><div class="value" id="kpiInProd">‚Äì</div><div class="sub">(blank + early statuses)</div></div>
      <div class="kpi"><div class="label">Ready For Delivery</div><div class="value" id="kpiRFD">‚Äì</div><div class="sub">Dispatch‚ÜíBilled</div></div>
      <div class="kpi"><div class="label">Delivered</div><div class="value" id="kpiDelivered">‚Äì</div><div class="sub">Tracking/Hand/Delivered/Cancelled</div></div>
    </div>

    <div class="card">
      <h2>Quick Filters</h2>
      <div class="controls">
        <label>Order Date <input type="date" id="dStart"> to <input type="date" id="dEnd"></label>
        <label>Sheet <select id="sheetFilter"></select></label>
        <label>Unit <select id="unitFilter"></select></label>
        <button class="btn" id="applyDash">Apply</button>
        <button id="resetDash">Reset</button>
      </div>
    </div>

    <div class="card">
      <h2>Branch-wise Status Count</h2>
      <div style="overflow:auto;">
        <table class="table" id="branchTable"></table>
      </div>
    </div>

    <div class="card">
      <h2>Unit-wise Status Count</h2>
      <div style="overflow:auto;">
        <table class="table" id="unitTable"></table>
      </div>
    </div>
  </main>
</div>

<script>
const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbyE5VORxmizRnO1Cnw0LVZjbl_f_ZBOgadrGynkJLfsl5QPs1ocPhDkOqpi_jH1tTZt/exec";
const SHEETS = ["Branch Sales Order","Jaipur Sales Order","Jaipur Alterations","Exhibition Sales Order","Wholesale Order"];
const ALL_STATUSES = ["","Order Received","Dye","Print Process","Print Received","For Work","From Work Received","Send To Party","Received From Party","Stitching","Finishing","Dispatch To Warehouse","Received At Warehouse","Send To D69","Received At D69","Ready For Delivery","Billed","Tracking Updated","Hand Delivery","Delivered","Cancelled"];

const sets = {
  inProd: ["","Order Received","Dye","Print Process","Print Received","For Work","From Work Received","Send To Party","Received From Party","Stitching","Finishing"],
  rfd: ["Dispatch To Warehouse","Received At Warehouse","Send To D69","Received At D69","Ready For Delivery","Billed"],
  delivered: ["Tracking Updated","Hand Delivery","Delivered","Cancelled"]
};

let rows=[]; // objects: { _sheet, Status, Unit, OrderDate (Date or ""), ... }

function clean(arr){ return Array.isArray(arr)?arr.filter(r=>Array.isArray(r)).map(r=>r.map(c=>c==null?"":String(c))):[]; }

async function loadData(){
  try{
    const res = await fetch(`${SCRIPT_URL}?t=${Date.now()}`);
    const json = await res.json();

    // Dynamically map each sheet; pick fields if present
    const out=[];
    SHEETS.forEach(name=>{
      const d=json[name];
      if(!Array.isArray(d)||d.length<2) return;
      const hs = d[0];
      const idx = k => hs.indexOf(k);
      const iStatus = idx("Status");
      const iUnit   = idx("Unit");
      const iOD     = idx("Order Date");
      const iTS     = idx("Timestamp");
      d.slice(1).forEach(r=>{
        const status = iStatus===-1 ? "" : (r[iStatus]??"");
        const unit   = iUnit===-1   ? "" : (r[iUnit]??"");
        const odRaw  = iOD!==-1 ? r[iOD] : (iTS!==-1 ? r[iTS] : "");
        const od = odRaw ? new Date(odRaw) : "";
        out.push({ _sheet:name, Status:String(status), Unit:String(unit), OrderDate: isNaN(od)? "" : od });
      });
    });

    rows = out;
    populateFilters();
    renderDashboard();
  }catch(e){
    console.error(e);
    document.getElementById("branchTable").innerHTML = `<tr><td style="color:#b00020;font-weight:600">‚ùå ${e.message}</td></tr>`;
  }
}

function populateFilters(){
  const sheets=[...new Set(rows.map(r=>r._sheet).filter(Boolean))];
  const units=[...new Set(rows.map(r=>r.Unit).filter(Boolean))];
  sheetFilter.innerHTML = `<option value="">All</option>` + sheets.map(s=>`<option>${s}</option>`).join("");
  unitFilter.innerHTML  = `<option value="">All</option>` + units.map(u=>`<option>${u}</option>`).join("");

  applyDash.onclick = ()=>{
    renderDashboard(sheetFilter.value, unitFilter.value, dStart.value, dEnd.value);
  };
  resetDash.onclick = ()=>{
    dStart.value=""; dEnd.value=""; sheetFilter.value=""; unitFilter.value="";
    renderDashboard();
  };
}

function renderDashboard(sheet="", unit="", ds="", de=""){
  // filter for dashboard
  const data = rows.filter(r=>{
    const okS = !sheet || r._sheet===sheet;
    const okU = !unit  || r.Unit===unit;
    const okD1= !ds    || (r.OrderDate && r.OrderDate>=new Date(ds));
    const okD2= !de    || (r.OrderDate && r.OrderDate<=new Date(de+"T23:59:59"));
    return okS && okU && okD1 && okD2;
  });

  // KPIs
  const total = data.length;
  const inProd = data.filter(r=>sets.inProd.includes((r.Status||"").trim())).length;
  const rfd    = data.filter(r=>sets.rfd.includes((r.Status||"").trim())).length;
  const delivered = data.filter(r=>sets.delivered.includes((r.Status||"").trim())).length;

  kpiTotal.textContent = total;
  kpiInProd.textContent = inProd;
  kpiRFD.textContent = rfd;
  kpiDelivered.textContent = delivered;

  const ods = data.map(r=>r.OrderDate).filter(d=>d && !isNaN(d));
  kpiRange.textContent = ods.length
    ? new Date(Math.min(...ods)).toLocaleDateString("en-GB",{day:"2-digit",month:"short",year:"numeric"}) + " ‚Äì " +
      new Date(Math.max(...ods)).toLocaleDateString("en-GB",{day:"2-digit",month:"short",year:"numeric"})
    : "";

  // counts by sheet & unit
  const bySheet = groupCounts(data, "_sheet");
  const byUnit  = groupCounts(data, "Unit");
  renderCountTable("branchTable","Branch", bySheet);
  renderCountTable("unitTable","Unit", byUnit);

  // enable sorting on both tables
  enableTableSorting("branchTable");
  enableTableSorting("unitTable");
}

function groupCounts(data, key){
  const map = {};
  // seed with all statuses so columns are stable
  const seed = ()=>Object.fromEntries(ALL_STATUSES.map(s=>[s,0]));
  data.forEach(r=>{
    const k = r[key] || "(unknown)";
    const s = (r.Status||"").trim();
    if(!map[k]) map[k]=seed();
    map[k][s] = (map[k][s]||0)+1;
  });
  return map;
}

function renderCountTable(tableId, firstCol, countsObj){
  const tbl=document.getElementById(tableId);
  let thead = `<thead><tr><th>${firstCol}</th>`;
  ALL_STATUSES.forEach(s=> thead += `<th>${s||"(blank)"}</th>`);
  thead += `<th>Total</th></tr></thead>`;

  const entries = Object.entries(countsObj);
  const totals = entries.map(([_,o])=>Object.values(o).reduce((a,b)=>a+b,0));
  const maxT = Math.max(1, ...totals);

  let tbody = "<tbody>";
  entries.forEach(([k,o])=>{
    const t = Object.values(o).reduce((a,b)=>a+b,0);
    tbody += `<tr><td>${k}</td>`;
    ALL_STATUSES.forEach(s=>{
      const val = o[s]||0;
      const click = firstCol==="Branch"
        ? `openOrders('sheet','${encodeURIComponent(k)}','${encodeURIComponent(s)}')`
        : `openOrders('unit','${encodeURIComponent(k)}','${encodeURIComponent(s)}')`;
      tbody += `<td class="clickable" onclick="${click}">${val}</td>`;
    });
    const pct = Math.round(t/maxT*100);
    tbody += `<td>${t}<div class="bar"><span style="width:${pct}%"></span></div></td></tr>`;
  });

  // grand total
  const grand = Object.fromEntries(ALL_STATUSES.map(s=>[s,0])); let gTot=0;
  entries.forEach(([_,o])=>{ ALL_STATUSES.forEach(s=> grand[s]+=o[s]||0); gTot += Object.values(o).reduce((a,b)=>a+b,0); });
  tbody += `<tr><th>Total</th>${ALL_STATUSES.map(s=>`<th>${grand[s]}</th>`).join("")}<th>${gTot}</th></tr>`;
  tbody += "</tbody>";

  tbl.innerHTML = thead + tbody;
}

function openOrders(kind, key, status){
  const p = new URLSearchParams();
  if (kind==="sheet") p.set("sheet", key);
  if (kind==="unit")  p.set("unit", key);
  p.set("status", status);
  // force hard load so filters reset + apply
  window.location.href = `orders.html#${p.toString()}`;
}

/* basic table sorting for dashboard tables */
function enableTableSorting(tableId){
  const tbl = document.getElementById(tableId);
  tbl.querySelectorAll("th").forEach((th,idx)=>{
    th.onclick = ()=>{
      const tbody = tbl.querySelector("tbody");
      const rows = [...tbody.querySelectorAll("tr")];
      const asc = !th.classList.contains("sort-asc");
      tbl.querySelectorAll("th").forEach(h=>h.classList.remove("sort-asc","sort-desc"));
      th.classList.add(asc?"sort-asc":"sort-desc");

      rows.sort((a,b)=>{
        const A = a.children[idx]?.innerText.trim() ?? "";
        const B = b.children[idx]?.innerText.trim() ?? "";
        const nA = parseFloat(A.replace(/[^0-9.]/g,""));
        const nB = parseFloat(B.replace(/[^0-9.]/g,""));
        const cmp = (isNaN(nA)||isNaN(nB)) ? A.localeCompare(B) : (nA-nB);
        return asc ? cmp : -cmp;
      });
      rows.forEach(r=>tbody.appendChild(r));
    };
  });
}

loadData();
</script>
</body>
</html>







