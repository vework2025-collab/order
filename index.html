<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>Vasansi Enterprise Application â€” Dashboard</title>
<link rel="stylesheet" href="assets/style.css">
</head>
<body>
<div class="app">
  <div class="topbar">
    <div class="title">Vasansi Enterprise Application</div>
    <div class="user">Hemant Solanki â–¼</div>
  </div>

  <!-- Sidebar -->
  <aside class="sidebar">
    <ul class="nav">
      <li><a href="index.html">ğŸ  <span class="label">Dashboard</span></a></li>
      <li><a href="dispatch.html">ğŸ“¦ <span class="label">Dispatch</span></a></li>
      <li><a href="jobwork.html">ğŸ§µ <span class="label">Job Work</span></a></li>
      <li class="section-title">Order</li>
      <li>
        <a href="orders.html">ğŸ“‹ <span class="label">Orders</span></a>
        <ul class="submenu">
          <li><a href="orders.html#Branch%20Sales%20Order">Branch Sales Order</a></li>
          <li><a href="orders.html#Jaipur%20Sales%20Order">Jaipur Sales Order</a></li>
          <li><a href="orders.html#Exhibition%20Sales%20Order">Exhibition Sales Order</a></li>
          <li><a href="orders.html#Wholesale%20Order">Wholesale Order</a></li>
        </ul>
      </li>
      <li><a href="production.html">ğŸ­ <span class="label">Production</span></a></li>
      <li><a href="reports.html">ğŸ“‘ <span class="label">Reports</span></a></li>
    </ul>
  </aside>

  <!-- Content -->
  <main class="content">
    <div class="card">
      <h2>Dashboard</h2>
      <div class="controls">
        <label><input type="checkbox" id="useFiltered"> Use current filters (from Orders)</label>
        <button class="btn" id="refreshBtn">Refresh</button>
      </div>
      <small>Counts are computed from the live Google Sheet data.</small>
    </div>

    <div class="card">
      <h2>Branch-wise Status Count (Sheet Name)</h2>
      <div style="overflow:auto;">
        <table class="table" id="branchTable"></table>
      </div>
    </div>

    <div class="card">
      <h2>Unit-wise Status Count</h2>
      <div style="overflow:auto;">
        <table class="table" id="unitTable"></table>
      </div>
    </div>
  </main>
</div>

<script src="assets/app.js"></script>
<script>
/* === CONFIG (same endpoint you already use) === */
const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbyE5VORxmizRnO1Cnw0LVZjbl_f_ZBOgadrGynkJLfsl5QPs1ocPhDkOqpi_jH1tTZt/exec";
const FIXED_SHEETS = [
  "Branch Sales Order","Jaipur Sales Order","Jaipur Alterations","Exhibition Sales Order","Wholesale Order"
];
const INCLUDED_COLUMNS = [
  "Timestamp","Sheet Name","Order No","Order Date","Delivery Date","Item","Design No","Unit",
  "Product Image","Order Form Photo","Remark","Status","Jobber Name"
];
const ALL_STATUSES = [
  "", "Order Received","Dye","Print Process","Print Received","For Work",
  "From Work Received","Send To Party","Received From Party","Stitching","Finishing",
  "Dispatch To Warehouse","Received At Warehouse","Send To D69","Received At D69",
  "Ready For Delivery","Billed","Tracking Updated","Hand Delivery","Delivered","Cancelled"
];

let headers=[], rows=[];

const clean = arr => Array.isArray(arr)?arr.filter(r=>Array.isArray(r)).map(r=>r.map(c=>c==null?"":String(c))):[];

async function loadData(){
  const res = await fetch(SCRIPT_URL);
  const data = await res.json();
  const combined = combineSheetsObject(data);
  headers = combined[0].map(h=>h||"");
  rows = clean(combined.slice(1));
  rows.sort((a,b)=>new Date(b[0])-new Date(a[0]));
}

function combineSheetsObject(obj){
  const out=[INCLUDED_COLUMNS];
  FIXED_SHEETS.forEach(sheet=>{
    const sheetData=obj[sheet];
    if(!Array.isArray(sheetData)||sheetData.length<2)return;
    const hs=sheetData[0];
    sheetData.slice(1).forEach(r=>{
      const mapped=INCLUDED_COLUMNS.map(h=>{
        const idx=hs.indexOf(h); return idx===-1?"":(r[idx]||"");
      });
      const tsIdx=hs.indexOf("Timestamp");
      mapped[0]=tsIdx>=0?r[tsIdx]:"";
      mapped[1]=sheet;
      out.push(mapped);
    });
  });
  return out;
}

function seedCounts(){ return Object.fromEntries(ALL_STATUSES.map(s=>[s,0])); }

function buildCounts(data, keyIndex){
  const idxStatus = headers.indexOf("Status");
  const acc = {};
  data.forEach(r=>{
    const key = r[keyIndex] || "(unknown)";
    const st  = r[idxStatus] || "";
    if(!acc[key]) acc[key]=seedCounts();
    acc[key][st] = (acc[key][st]||0) + 1;
  });
  return acc;
}

function renderCountTable(tableId, firstColLabel, countsObj){
  const tbl=document.getElementById(tableId);
  let thead=`<thead><tr><th>${firstColLabel}</th>`;
  ALL_STATUSES.forEach(s=>thead+=`<th>${s||"(blank)"}</th>`); thead+=`<th>Total</th></tr></thead>`;
  let tbody="<tbody>";
  const entries=Object.entries(countsObj);
  const totals=entries.map(([_,o])=>Object.values(o).reduce((a,b)=>a+b,0));
  const maxTotal=Math.max(1,...totals);
  entries.forEach(([k,o])=>{
    const total=Object.values(o).reduce((a,b)=>a+b,0);
    tbody+=`<tr><td>${k}</td>`;
    ALL_STATUSES.forEach(s=>tbody+=`<td>${o[s]||0}</td>`);
    const pct=Math.round(total/maxTotal*100);
    tbody+=`<td>${total}<div class="bar"><span style="width:${pct}%"></span></div></td></tr>`;
  });
  // grand total
  const grand=seedCounts(); let gTot=0;
  entries.forEach(([_,o])=>{ ALL_STATUSES.forEach(s=>grand[s]+=o[s]||0); gTot+=Object.values(o).reduce((a,b)=>a+b,0); });
  tbody+=`<tr><th>Total</th>`; ALL_STATUSES.forEach(s=>tbody+=`<th>${grand[s]}</th>`); tbody+=`<th>${gTot}</th></tr>`;
  tbody+="</tbody>";
  tbl.innerHTML=thead+tbody;
}

async function refresh(){
  if(!rows.length) await loadData();
  const idxSheet = headers.indexOf("Sheet Name");
  const idxUnit  = headers.indexOf("Unit");

  const branchCounts = buildCounts(rows, idxSheet);
  const unitCounts   = buildCounts(rows, idxUnit);

  renderCountTable("branchTable","Branch",branchCounts);
  renderCountTable("unitTable","Unit",unitCounts);
}

document.getElementById("refreshBtn").addEventListener("click", refresh);
refresh();
</script>
</body>
</html>
