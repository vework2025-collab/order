<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Vasansi Jaipur Order Dashboard</title>
<style>
  body{font-family:'Segoe UI',sans-serif;background:#f7f8fa;padding:15px;}
  h2{text-align:center;margin:10px 0;}
  table{width:100%;border-collapse:collapse;background:white;}
  th,td{border:1px solid #ccc;padding:6px 8px;text-align:left;font-size:13px;}
  th{background:#f2f2f2;}
  img{width:80px;height:100px;object-fit:cover;border-radius:5px;}
  select,input,button{padding:5px;margin:3px;}
  button{background:#007bff;color:#fff;border:none;border-radius:4px;cursor:pointer;}
  .save-btn{background:#28a745;}
  .save-btn:disabled{background:#ccc;}
</style>
</head>
<body>
<h2>üíª Vasansi Jaipur Order Dashboard</h2>

<div style="margin-bottom:10px;">
  <label>Order No: <input type="text" id="filterOrder"></label>
  <label>Unit: <select id="filterUnit"></select></label>
  <label>Sheet: <select id="filterSheet"></select></label>
  <button onclick="applyFilters()">Apply</button>
  <button onclick="resetFilters()">Reset</button>
</div>

<table id="dataTable"></table>

<script>
const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbz2kFMgF5F7k7-yvLeamZ5LZ4eiWqaMRj18K0XnZX1YYSuiwHbjoR1gJu1O9BDL_uo0/exec";
const SHEETS = ["Branch Sales Order","Jaipur Sales Order","Jaipur Alterations","Exhibition Sales Order","Wholesale Order"];
const INCLUDED = ["Timestamp","Sheet Name","Order No","Order Date","Delivery Date","Item","Design No","Branch Name","Salesman","Product Image","Order Form Photo","Remark","Unit","Delivery Type","Status","Jobber Name"];
let headers=[],rows=[],filtered=[];

async function loadData(){
  const tbl=document.getElementById("dataTable");
  tbl.innerHTML="<tr><td>Loading...</td></tr>";
  const res=await fetch(SCRIPT_URL);
  const data=await res.json();
  const combined=combineSheets(data);
  headers=combined[0]; rows=combined.slice(1); filtered=rows;
  renderTable(); fillFilters();
}

function combineSheets(obj){
  const out=[INCLUDED];
  const norm=s=>String(s).trim().toLowerCase().replace(/\s*\[.*?\]/g,"").replace(/[^a-z0-9]/g,"");
  SHEETS.forEach(name=>{
    const sh=obj[name]; if(!sh||sh.length<2)return;
    const hdr=sh[0].map(norm);
    sh.slice(1).forEach(r=>{
      const row=INCLUDED.map(h=>{
        const i=hdr.indexOf(norm(h));
        return i==-1?"":r[i]||"";
      });
      row[0]=r[hdr.indexOf(norm("timestamp"))]||"";
      row[1]=name; out.push(row);
    });
  });
  return out;
}

function renderTable(){
  const tbl=document.getElementById("dataTable");
  if(!filtered.length){tbl.innerHTML="<tr><td>No data found</td></tr>";return;}
  const today=new Date(); today.setHours(0,0,0,0);
  const dIdx=headers.indexOf("Delivery Date");
  let html="<tr>"+headers.map(h=>`<th>${h}</th>`).join("")+"<th>Action</th></tr>";
  filtered.forEach(r=>{
    const d=new Date(r[dIdx]);
    const overdue=(d<today&&!isNaN(d));
    html+=`<tr${overdue?' style="background:#ffcccc"':''}>`;
    headers.forEach((h,i)=>{
      let val=r[i]||"",hLow=h.toLowerCase();
      if(hLow.includes("date")) val=formatDate(val);
      else if(hLow.includes("image")||hLow.includes("photo")){
        const t=toThumb(val); if(t) val=`<a href="${val}" target="_blank"><img src="${t}"></a>`;
      }
      else if(h.toLowerCase().trim() === "status"){
  const statuses = [
    "Order Received","Print Process","Print Received","For Work",
    "From Work Received","Stitching","Finishing",
    "Ready For Billing","Delivered"
  ];
  val = `<select>
           ${statuses.map(s=>`<option ${s===r[i]?"selected":""}>${s}</option>`).join("")}
         </select>`;
}

      html+=`<td>${val}</td>`;
    });
    html+=`<td><button class="save-btn" onclick="saveRow(this,'${r[1]}')">Save</button></td></tr>`;
  });
  tbl.innerHTML=html;
}

function toThumb(u){const id=u.match(/[-\w]{25,}/);return id?`https://drive.google.com/thumbnail?id=${id[0]}&sz=w100-h100`:"";}
function formatDate(v){if(!v)return"";const d=new Date(v);return isNaN(d)?v:d.toLocaleDateString("en-GB",{day:"2-digit",month:"short",year:"numeric"});}

function fillFilters(){
  const uSet=new Set(), sSet=new Set();
  const iU=headers.indexOf("Unit"), iS=headers.indexOf("Sheet Name");
  rows.forEach(r=>{if(r[iU])uSet.add(r[iU]);if(r[iS])sSet.add(r[iS]);});
  document.getElementById("filterUnit").innerHTML=`<option value="">All</option>`+[...uSet].map(u=>`<option>${u}</option>`).join("");
  document.getElementById("filterSheet").innerHTML=`<option value="">All</option>`+[...sSet].map(s=>`<option>${s}</option>`).join("");
}

function applyFilters(){
  const o=document.getElementById("filterOrder").value.toLowerCase();
  const u=document.getElementById("filterUnit").value;
  const s=document.getElementById("filterSheet").value;
  const iO=headers.indexOf("Order No"), iU=headers.indexOf("Unit"), iS=headers.indexOf("Sheet Name");
  filtered=rows.filter(r=>(!o||r[iO].toLowerCase().includes(o))&&(!u||r[iU]===u)&&(!s||r[iS]===s));
  renderTable();
}
function resetFilters(){document.querySelectorAll("#filterOrder,#filterUnit,#filterSheet").forEach(e=>e.value="");filtered=rows;renderTable();}

async function saveRow(btn,sheet){
  const tr=btn.closest("tr"),tds=[...tr.children];
  const iO=headers.indexOf("Order No"), iS=headers.indexOf("Status"), iR=headers.indexOf("Remark");
  const orderNo=tds[iO]?.innerText.trim()||"";
  const statusSel=tds[iS].querySelector("select");
  const status=statusSel?statusSel.value:"";
  const remark=tds[iR]?.innerText.trim()||"";
  if(!orderNo){alert("‚ùå Missing Order No");return;}
  btn.disabled=true;const old=btn.innerText;btn.innerText="Saving...";
  try{
    const res=await fetch(SCRIPT_URL,{method:"POST",headers:{"Content-Type":"application/json"},
      body:JSON.stringify({sheetName:sheet,orderNo,status,remark})});
    const j=await res.json();
    if(j.success){btn.innerText="Saved ‚úÖ";setTimeout(()=>{btn.innerText=old;btn.disabled=false;},1500);}
    else throw new Error(j.error||"Update failed");
  }catch(e){alert("‚ùå "+e.message);btn.innerText=old;btn.disabled=false;}
}

loadData();
</script>
</body>
</html>

