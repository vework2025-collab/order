<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Vasansi Jaipur Order Dashboard</title>
<style>
  body { font-family: "Segoe UI", sans-serif; background: #f7f8fa; padding: 20px; }
  h1 { text-align: center; margin-bottom: 15px; }
  table { width: 100%; border-collapse: collapse; background: white; }
  th, td { border: 1px solid #ddd; padding: 6px 8px; text-align: left; font-size: 13px; white-space: nowrap; }
  th { background: #f2f2f2; position: sticky; top: 0; z-index: 2; cursor: pointer; }
  th.sort-asc::after { content: " ‚ñ≤"; }
  th.sort-desc::after { content: " ‚ñº"; }
  img { width: 100px; height: 150px; object-fit: cover; border-radius: 5px; }
  .controls { display: flex; flex-wrap: wrap; justify-content: center; gap: 5px; margin-bottom: 15px; }
  select, input, button { padding: 6px; border-radius: 4px; border: 1px solid #ccc; }
  button { background: #007bff; color: white; cursor: pointer; border: none; }
  button:hover { background: #0056b3; }
  .save-btn { background: #28a745; color: white; padding: 5px 10px; border-radius: 4px; }
  .remark-cell { white-space: normal; max-width: 400px; min-width: 150px; }
  .pagination { text-align: center; margin-top: 10px; }
  .pagination button { margin: 0 2px; padding: 5px 10px; border: 1px solid #007bff; border-radius: 4px; background: white; color: #007bff; }
  .pagination button.active { background: #007bff; color: white; }
  .pagination button[disabled] { opacity: 0.4; cursor: not-allowed; }
  #entriesSelect { border: 1px solid #ccc; border-radius: 4px; padding: 4px 6px; margin: 0 4px; }
  .status-checkboxes { display: flex; flex-wrap: wrap; gap: 8px; justify-content: center; max-width: 1010px; margin: 0 auto; }
  .status-checkboxes label { font-size: 15px; display: flex; align-items: center; gap: 4px; }
</style>
</head>
<body>
<h1>üíª Vasansi Jaipur Order Dashboard</h1>

<div class="controls">
  <label>Order No: <input type="text" id="filterOrderNo" placeholder="Enter order no..."></label>
  <label>Order Date: <input type="date" id="filterOrderStart"> to <input type="date" id="filterOrderEnd"></label>
  <label>Delivery Date: <input type="date" id="filterDeliveryStart"> to <input type="date" id="filterDeliveryEnd"></label>
  <label>Unit: <select id="filterUnit"></select></label>
  <label>Sheet Name: <select id="filterSheet"></select></label>
</div>

<div class="controls">
  <label><strong>Status:</strong></label>
  <div class="status-checkboxes" id="statusCheckboxes"></div>
  <button onclick="applyFilters()">Apply</button>
  <button onclick="resetFilters()">Reset</button>
</div>

<div class="controls" style="justify-content: space-between; align-items: center;">
  <input type="text" id="searchBar" placeholder="üîç Search..." oninput="searchTable()">
  <label>Show 
    <select id="entriesSelect" onchange="changeEntries()">
      <option value="10">10</option>
      <option value="25" selected>25</option>
      <option value="50">50</option>
      <option value="100">100</option>
    </select> entries
  </label>
</div>

<table id="dataTable"></table>
<div class="pagination" id="pagination"></div>

<script>
const SCRIPT_URL = "PASTE_YOUR_NEW_WEBAPP_URL_HERE"; // replace after re-deploy
const FIXED_SHEETS = [
  "Branch Sales Order", "Jaipur Sales Order", "Jaipur Alterations",
  "Exhibition Sales Order", "Wholesale Order"
];
const INCLUDED_COLUMNS = [
  "Timestamp","Sheet Name","Order No","Order Date","Delivery Date",
  "Item","Design No","Unit","Product Image","Order Form Photo",
  "Remark","Status","Jobber Name"
];

let headers=[], rows=[], filteredRows=[], currentPage=1, rowsPerPage=25;

const safeLower=v=>(v==null?"":String(v).toLowerCase());
const clean=arr=>Array.isArray(arr)?arr.filter(r=>Array.isArray(r)).map(r=>r.map(c=>c==null?"":String(c))):[];

function formatDateTime(v){
  if(!v)return""; const d=new Date(v);
  return isNaN(d)?v:d.toLocaleDateString("en-GB",{day:"2-digit",month:"short",year:"numeric"});
}
function toThumb(url){
  if(!url)return""; const id=url.match(/[-\w]{25,}/); return id?`https://drive.google.com/thumbnail?id=${id[0]}&sz=w200-h200`:"";
}

async function loadData(){
  document.getElementById("dataTable").innerHTML="<tr><td>Loading...</td></tr>";
  try{
    const res=await fetch(SCRIPT_URL);
    const text=await res.text();
    console.log("üîç Raw Response:", text.slice(0,300));
    const data=JSON.parse(text);
    const combined=combineSheetsObject(data);
    headers=combined[0]; rows=clean(combined.slice(1));
    rows.sort((a,b)=>new Date(b[0])-new Date(a[0]));
    filteredRows=rows; populateFilters(); renderTable();
  }catch(e){
    document.getElementById("dataTable").innerHTML=`<tr><td>‚ùå ${e.message}</td></tr>`;
  }
}

function combineSheetsObject(obj){
  const out=[INCLUDED_COLUMNS];
  FIXED_SHEETS.forEach(sheet=>{
    const d=obj[sheet];
    if(!Array.isArray(d)||d.length<2)return;
    const hdr=d[0];
    d.slice(1).forEach(r=>{
      const mapped=INCLUDED_COLUMNS.map(h=>{
        const i=hdr.indexOf(h);
        return i===-1?"":r[i]||"";
      });
      const t=hdr.indexOf("Timestamp");
      mapped[0]=t>=0?r[t]:"";
      mapped[1]=sheet;
      out.push(mapped);
    });
  });
  return out;
}

function populateFilters(){
  const units=new Set(), sheets=new Set();
  const statuses=["","Order Received","Dye","Print Process","Print Received","For Work","From Work Received","Send To Party","Received From Party","Stitching","Finishing","Dispatch To Warehouse","Received At Warehouse","Send To D69","Received At D69","Ready For Delivery","Billed","Tracking Updated","Hand Delivery","Delivered","Cancelled"];
  const u=headers.indexOf("Unit"), s=headers.indexOf("Sheet Name");
  rows.forEach(r=>{if(r[u])units.add(r[u]); if(r[s])sheets.add(r[s]);});
  document.getElementById("filterUnit").innerHTML=`<option value="">All</option>${[...units].map(u=>`<option>${u}</option>`).join("")}`;
  document.getElementById("filterSheet").innerHTML=`<option value="">All</option>${[...sheets].map(n=>`<option>${n}</option>`).join("")}`;
  document.getElementById("statusCheckboxes").innerHTML=statuses.map(s=>`<label><input type="checkbox" value="${s}">${s||"(blank)"}</label>`).join("");
}

function applyFilters(){
  const oNo=safeLower(document.getElementById("filterOrderNo").value),
        oS=document.getElementById("filterOrderStart").value, oE=document.getElementById("filterOrderEnd").value,
        dS=document.getElementById("filterDeliveryStart").value, dE=document.getElementById("filterDeliveryEnd").value,
        unit=document.getElementById("filterUnit").value,
        sheet=document.getElementById("filterSheet").value,
        sel=[...document.querySelectorAll(".status-checkboxes input:checked")].map(i=>i.value),
        iO=headers.indexOf("Order No"), iOD=headers.indexOf("Order Date"), iDD=headers.indexOf("Delivery Date"), iU=headers.indexOf("Unit"), iS=headers.indexOf("Status");
  filteredRows=rows.filter(r=>{
    const od=new Date(r[iOD]||""), dd=new Date(r[iDD]||"");
    return (!oNo||safeLower(r[iO]).includes(oNo))
        &&(!sheet||r[1]===sheet)
        &&(!unit||r[iU]===unit)
        &&(!sel.length||sel.includes(r[iS])||(r[iS]==""||r[iS]==null))
        &&(!oS||od>=new Date(oS))
        &&(!oE||od<=new Date(oE+"T23:59:59"))
        &&(!dS||dd>=new Date(dS))
        &&(!dE||dd<=new Date(dE+"T23:59:59"));
  });
  currentPage=1; renderTable();
}

function resetFilters(){
  document.querySelectorAll("input,select").forEach(e=>e.value="");
  document.querySelectorAll(".status-checkboxes input").forEach(i=>i.checked=false);
  filteredRows=rows; currentPage=1; renderTable();
}

function renderTable(){
  const tbl=document.getElementById("dataTable");
  if(!filteredRows.length){tbl.innerHTML="<tr><td>No data found</td></tr>"; return;}
  const start=(currentPage-1)*rowsPerPage, end=start+rowsPerPage, page=filteredRows.slice(start,end);
  let html="<thead><tr>"+headers.map(h=>`<th>${h}</th>`).join("")+"<th>Actions</th></tr></thead><tbody>";
  page.forEach(r=>{
    html+="<tr>";
    headers.forEach((h,i)=>{
      let val=r[i]||""; const low=safeLower(h);
      if(low.includes("timestamp")||low.includes("date"))val=formatDateTime(val);
      else if((low.includes("image")||low.includes("photo"))&&val.includes("drive.google.com")){
        const t=toThumb(val); val=t?`<a href='${val}' target='_blank'><img src='${t}'></a>`:val;
      } else if(h==="Status"){
        const all=["","Order Received","Dye","Print Process","Print Received","For Work","From Work Received","Send To Party","Received From Party","Stitching","Finishing","Dispatch To Warehouse","Received At Warehouse","Send To D69","Received At D69","Ready For Delivery","Billed","Tracking Updated","Hand Delivery","Delivered","Cancelled"];
        val="<select>"+all.map(s=>`<option ${s===r[i]?"selected":""}>${s||"(blank)"}</option>`).join("")+"</select>";
      } else if(h==="Remark")val=`<div class='remark-cell'>${val}</div>`;
      html+=`<td>${val}</td>`;
    });
    html+=`<td><button class='save-btn' onclick="saveRow(this,'${r[1]}')">Save</button>
    <button onclick="generateOrderPrint('${r[1]}','${r[headers.indexOf("Order No")]}')">üßæ Print</button></td></tr>`;
  });
  tbl.innerHTML=html+"</tbody>";
}
loadData();
</script>
</body>
</html>
