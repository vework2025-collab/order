<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>Vasansi Enterprise Application â€” Orders</title>
<link rel="stylesheet" href="assets/style.css">
<link rel="icon" href="data:,">
<style>
  body { font-family: Segoe UI, sans-serif; }
  #dataTable { width:100%; border-collapse:collapse; background:#fff; }
  #dataTable th, #dataTable td {
    border:1px solid #ddd; padding:6px 8px; font-size:13px; white-space:nowrap;
  }
  #dataTable th { background:#f5f6f7; position:sticky; top:0; }
  img { width:100px; height:150px; object-fit:cover; border-radius:5px; }
</style>
</head>
<body>
<div class="app">
  <div class="topbar">
    <div class="title">Vasansi Enterprise Application</div>
    <div class="user">Hemant Solanki â–¼</div>
  </div>

  <aside class="sidebar">
    <ul class="nav">
      <li><a href="index.html">ğŸ  <span class="label">Dashboard</span></a></li>
      <li><a href="dispatch.html">ğŸ“¦ <span class="label">Dispatch</span></a></li>
      <li><a href="jobwork.html">ğŸ§µ <span class="label">Job Work</span></a></li>
      <li class="section-title">Order</li>
      <li>
        <a href="orders.html">ğŸ“‹ <span class="label">All Orders</span></a>
        <ul class="submenu">
          <li><a href="orders.html#Branch%20Sales%20Order">Branch Sales Order</a></li>
          <li><a href="orders.html#Jaipur%20Sales%20Order">Jaipur Sales Order</a></li>
          <li><a href="orders.html#Jaipur%20Alterations">Jaipur Alterations</a></li>
          <li><a href="orders.html#Exhibition%20Sales%20Order">Exhibition Sales Order</a></li>
          <li><a href="orders.html#Wholesale%20Order">Wholesale Order</a></li>
        </ul>
      </li>
      <li><a href="production.html">ğŸ­ <span class="label">Production</span></a></li>
      <li><a href="reports.html">ğŸ“‘ <span class="label">Reports</span></a></li>
    </ul>
  </aside>

  <main class="content">
    <div class="card">
      <h2>All Orders</h2>
      <table id="dataTable"><tr><td>Loading data...</td></tr></table>
    </div>
  </main>
</div>

<script src="assets/app.js"></script>
<script>
const SCRIPT_URL =
  "https://script.google.com/macros/s/AKfycbyE5VORxmizRnO1Cnw0LVZjbl_f_ZBOgadrGynkJLfsl5QPs1ocPhDkOqpi_jH1tTZt/exec";

const SHEETS = [
  "Branch Sales Order","Jaipur Sales Order","Jaipur Alterations",
  "Exhibition Sales Order","Wholesale Order"
];

// ========== Helpers ==========
function clean(arr){
  return Array.isArray(arr)
    ? arr.filter(r=>Array.isArray(r)).map(r=>r.map(c=>c==null?"":String(c)))
    : [];
}

// ========== Loader ==========
async function loadData(){
  const tbl=document.getElementById("dataTable");
  tbl.innerHTML="<tr><td>Loading data...</td></tr>";
  try{
    const res=await fetch(`${SCRIPT_URL}?t=${Date.now()}`);
    if(!res.ok) throw new Error("Network error: "+res.status);
    const json=await res.json();
    console.log("âœ… Received keys:",Object.keys(json));

    // flatten all sheets into one array of objects
    let rows=[];
    SHEETS.forEach(name=>{
      const data=json[name];
      if(!Array.isArray(data)||data.length<2) return;
      const headers=data[0];
      data.slice(1).forEach(r=>{
        const obj={};
        headers.forEach((h,i)=>obj[h]=r[i]||"");
        obj.Sheet=name;
        rows.push(obj);
      });
    });

    if(!rows.length){ tbl.innerHTML="<tr><td>No data found</td></tr>"; return; }

    // if page hash (like #Jaipur Sales Order) exists, filter by sheet
    if(location.hash){
      const branch = decodeURIComponent(location.hash.substring(1));
      rows = rows.filter(r => r.Sheet === branch);
      console.log("ğŸ” Filtered for sheet:", branch, rows.length);
    }

    // render table
    const headers = Object.keys(rows[0]);
    let html="<thead><tr>"+headers.map(h=>`<th>${h}</th>`).join("")+"</tr></thead><tbody>";
    rows.forEach(r=>{
      html+="<tr>"+headers.map(h=>{
        let v=r[h];
        // small image preview for Drive links
        if(typeof v==="string" && v.includes("drive.google.com")){
          const id=(v.match(/[-\\w]{25,}/)||[])[0];
          if(id) v=`<a href="${v}" target="_blank"><img src="https://drive.google.com/thumbnail?id=${id}&sz=w100-h100"></a>`;
        }
        return `<td>${v}</td>`;
      }).join("")+"</tr>";
    });
    html+="</tbody>";
    tbl.innerHTML=html;
  }catch(e){
    console.error(e);
    tbl.innerHTML=`<tr><td style="color:red">âŒ ${e.message}</td></tr>`;
  }
}

loadData();
</script>
</body>
</html>
